# üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ v2.0 - –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

**–î–∞—Ç–∞:** 20 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 2.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ

## –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- ‚ùå –°—á—ë—Ç—á–∏–∫ –Ω–∞—Ä—É—à–µ–Ω–∏–π —Å–±—Ä–∞—Å—ã–≤–∞–ª—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- ‚ùå –í—Ä–µ–º—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–ª–æ—Å—å (–≤—Å–µ–≥–¥–∞ 1 —Å–µ–∫)
- ‚ùå –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –∑–ª–æ—Å—Ç–Ω—ã—Ö —Å–ø–∞–º–µ—Ä–æ–≤

### –†–µ—à–µ–Ω–∏–µ v2.0
- ‚úÖ **–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–π** (–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–∏ 60 —Å–µ–∫)
- ‚úÖ **–ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ** (2 ‚Üí 58 —Å–µ–∫—É–Ω–¥)
- ‚úÖ **–ê–≤—Ç–æ–±–∞–Ω –Ω–∞ 1 —á–∞—Å** –ø–æ—Å–ª–µ 30 –Ω–∞—Ä—É—à–µ–Ω–∏–π –∑–∞ –º–∏–Ω—É—Ç—É
- ‚úÖ **–ß–µ—Ç—ã—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π**

## –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π
```python
# –ù–∞—Ä—É—à–µ–Ω–∏—è —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–∏ 60 —Å–µ–∫—É–Ω–¥
# –°—Ç–∞—Ä—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è
violation_window=60
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω
```python
# –ü–æ—Å–ª–µ 30 –Ω–∞—Ä—É—à–µ–Ω–∏–π –∑–∞ –º–∏–Ω—É—Ç—É ‚Üí –±–∞–Ω –Ω–∞ 1 —á–∞—Å
max_violations=30
banned_until = now + 3600
```

### 3. –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ

| –ù–∞—Ä—É—à–µ–Ω–∏–π | –í—Ä–µ–º—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ |
|-----------|------------------|
| 1-3       | 2 —Å–µ–∫           |
| 4-10      | 6-10 —Å–µ–∫        |
| 11-20     | 12-30 —Å–µ–∫       |
| 21-29     | 42-58 —Å–µ–∫       |
| **30+**   | **–ë–ê–ù 1 –ß–ê–°**   |

### 4. –ß–µ—Ç—ã—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

1. **–û–±—ã—á–Ω–æ–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ** (1-5 –Ω–∞—Ä—É—à–µ–Ω–∏–π)
2. **–û–±–Ω–∞—Ä—É–∂–µ–Ω —Å–ø–∞–º** (6-20 –Ω–∞—Ä—É—à–µ–Ω–∏–π) + —Å—á—ë—Ç—á–∏–∫
3. **–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ** (21-29) + —É–≥—Ä–æ–∑–∞ –±–∞–Ω–∞
4. **–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞** (30+) + –≤—Ä–µ–º—è –¥–æ —Ä–∞–∑–±–∞–Ω–∞

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

```python
# bot.py
rate_limit_middleware = RateLimitMiddleware(
    rate=2,              # 2 –∑–∞–ø—Ä–æ—Å–∞/—Å–µ–∫
    period=1,            # –∑–∞ 1 —Å–µ–∫—É–Ω–¥—É
    burst=4,             # –º–∞–∫—Å–∏–º—É–º 4 –ø–æ–¥—Ä—è–¥
    max_violations=30,   # –±–∞–Ω –ø–æ—Å–ª–µ 30 –Ω–∞—Ä—É—à–µ–Ω–∏–π
    violation_window=60  # –≤ —Ç–µ—á–µ–Ω–∏–∏ 60 —Å–µ–∫—É–Ω–¥
)
```

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

```python
stats = rate_limit_middleware.get_stats()
# {
#     'total_users': 150,
#     'banned_users': 3,           # ‚≠ê –ù–û–í–û–ï
#     'users_with_violations': 25, # ‚≠ê –ù–û–í–û–ï
#     'rate': 2,
#     'period': 1,
#     'burst': 4,
#     'max_violations': 30,        # ‚≠ê –ù–û–í–û–ï
#     'violation_window': 60       # ‚≠ê –ù–û–í–û–ï
# }
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```
WARNING - Rate limit exceeded for user X. 
          Wait time: 15s, violations: 15/30, tokens: 0.34

CRITICAL - User X PERMANENTLY BANNED for 30+ violations

ERROR - BANNED user X tried to access. Ban remaining: 3540s
```

## –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. ‚úÖ `app/middlewares/rate_limit.py` - –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–∞
2. ‚úÖ `bot.py` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
3. ‚úÖ `SPAM_PROTECTION_IMPROVEMENTS.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è v2.0
4. ‚úÖ `SPAM_PROTECTION_v2_SUMMARY.md` - —ç—Ç–∞ —Å–≤–æ–¥–∫–∞

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –û–±—ã—á–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
```
–ó–∞–ø—Ä–æ—Å—ã 1-4 ‚Üí ‚úÖ OK
–ü–∞—É–∑–∞ 1 —Å–µ–∫ ‚Üí ‚úÖ –¢–æ–∫–µ–Ω—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å
–ó–∞–ø—Ä–æ—Å—ã 5-8 ‚Üí ‚úÖ OK
```

### –¢–µ—Å—Ç 2: –°–ø–∞–º
```
–ó–∞–ø—Ä–æ—Å—ã 1-4   ‚Üí ‚úÖ OK
–ó–∞–ø—Ä–æ—Å—ã 5-10  ‚Üí ‚ö†Ô∏è –ë–õ–û–ö–ò–†–û–í–ö–ê 2-10 —Å–µ–∫
–ó–∞–ø—Ä–æ—Å—ã 11-29 ‚Üí üî¥ –ë–õ–û–ö–ò–†–û–í–ö–ê 12-58 —Å–µ–∫
–ó–∞–ø—Ä–æ—Å 30     ‚Üí üö´ –ë–ê–ù –ù–ê 1 –ß–ê–°
```

## –ó–∞–ø—É—Å–∫

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
python bot.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -f logs/bot.log | grep "rate_limit"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥
# –û–∂–∏–¥–∞–µ—Ç—Å—è: –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–°–ø–∞–º–µ—Ä—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è**  
‚úÖ **–ß–µ—Å—Ç–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Å—Ç—Ä–∞–¥–∞—é—Ç**  
‚úÖ **–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è**  
‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ production**

---

**–í–µ—Ä—Å–∏—è:** 2.0  
**–°—Ç–∞—Ç—É—Å:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ ‚úÖ

