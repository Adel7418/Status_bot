# Исправление времени в напоминаниях и изменение интервала

## Дата: 12 октября 2025

## Проблема

1. **Неверное время в напоминаниях**: При назначении мастера на заявку через 20 минут приходило напоминание с текстом "назначена 202 минуты назад" вместо "20 минут назад"
2. **Большой интервал напоминаний**: Напоминания отправлялись каждые 10 минут, что было слишком редко

## Причина проблемы

**SQLite хранит время в UTC**, а Python функция `datetime.now()` возвращает **локальное время**. Это создавало разницу в ~180 минут (часовой пояс UTC+3), которая добавлялась к реальному времени назначения.

### Пример:
- Заявка назначена в 12:00 по МСК (UTC+3)
- SQLite сохранил время как 09:00 UTC
- При проверке через 20 минут:
  - `datetime.now()` = 12:20 МСК
  - `order.updated_at` = 09:00 UTC
  - Разница = 3 часа 20 минут = 200 минут ❌

## Решение

### 1. Изменен интервал напоминаний

**Файл**: `app/services/scheduler.py`

```python
# Было:
trigger=IntervalTrigger(minutes=10)

# Стало:
trigger=IntervalTrigger(minutes=5)
```

Теперь напоминания отправляются **каждые 5 минут** вместо 10.

### 2. Исправлено сравнение времени

**Файл**: `app/services/scheduler.py`

Изменено во всех функциях планировщика:

```python
# Было:
now = datetime.now()

# Стало:
now = datetime.utcnow()
```

Теперь используется **UTC время** для сравнения, что соответствует времени в базе данных.

### Затронутые функции:
1. `check_order_sla()` - проверка SLA заявок
2. `send_daily_summary()` - ежедневная сводка
3. `remind_assigned_orders()` - напоминания о непринятых заявках

### 3. Добавлено логирование

Добавлено подробное логирование для отладки:

```python
logger.debug(f"Order #{order.id}: updated_at={order.updated_at}, now={now}, time_assigned={time_assigned}")
logger.info(f"Sending reminder for order #{order.id}: assigned {minutes} minutes ago")
```

## Результат

✅ **Время в напоминаниях теперь корректное**
- Если заявка назначена 20 минут назад, в напоминании будет: "⏱ Назначена 20 мин. назад"

✅ **Напоминания приходят чаще**
- Интервал: каждые 5 минут (было 10 минут)
- Порог срабатывания: 15 минут после назначения (не изменился)

✅ **Улучшенное логирование**
- Можно отслеживать, как рассчитывается время для каждой заявки
- Видно, когда отправляются напоминания

## Проверка работы

1. Создайте новую заявку
2. Назначьте мастера на заявку
3. Подождите 15+ минут
4. В следующем цикле напоминаний (каждые 5 минут) придет уведомление с **корректным временем**

## Технические детали

### База данных
- SQLite использует UTC время для `CURRENT_TIMESTAMP`
- Колонка `updated_at` обновляется при назначении мастера

### Планировщик
- **APScheduler** запускает задачи по расписанию
- Задача `remind_assigned_orders` выполняется каждые 5 минут
- Порог напоминания: 15 минут после назначения

### Расчет времени
```python
now = datetime.utcnow()              # Текущее UTC время
time_assigned = now - order.updated_at  # Разница в UTC
minutes = int(time_assigned.total_seconds() / 60)  # Минуты
```

## Связанные файлы

- `app/services/scheduler.py` - основной файл с изменениями
- `app/database/db.py` - сохранение времени в UTC
- `app/handlers/dispatcher.py` - назначение мастера и обновление `updated_at`

## История изменений

### 12.10.2025 - Версия 1
- Изменен интервал напоминаний с 10 на 5 минут
- Исправлено сравнение времени (используется UTC)
- Добавлено подробное логирование

