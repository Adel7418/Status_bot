# 📊 Новый лист: Заявки по мастерам

## ✅ Что добавлено

В Excel отчеты добавлен новый лист **"Заявки по мастерам"** с детальной информацией по каждой заявке каждого мастера.

---

## 📋 Структура листа

### Заголовки колонок:

| № | Колонка | Описание |
|---|---------|----------|
| 1 | Мастер | Имя мастера (в заголовке группы) |
| 2 | ID | Номер заявки |
| 3 | Статус | Текущий статус с эмодзи |
| 4 | Тип техники | Что ремонтируется |
| 5 | Клиент | Имя клиента |
| 6 | Адрес | Адрес клиента |
| 7 | Телефон | Контакт клиента |
| 8 | Создана | Дата создания |
| 9 | Обновлена | Дата последнего обновления |
| 10 | Сумма | Общая сумма заказа |
| 11 | Материалы | Стоимость материалов |
| 12 | Прибыль мастера | Доход мастера |
| 13 | Сдача в кассу | Прибыль компании |
| 14 | Примечания | Доп. информация |

---

## 🎨 Визуальное оформление

### Группировка по мастерам:

```
┌─────────────────────────────────────────┐
│ 👨‍🔧 Петров Петр Петрович              │ ← Зеленый заголовок
├─────────────────────────────────────────┤
│ Заявка #15  | ⚙️ IN_PROGRESS | Холод.  │
│ Заявка #18  | ✅ ACCEPTED    | Стиралка│
│ Заявка #22  | 🔒 CLOSED      | Плита   │
├─────────────────────────────────────────┤
│ Итого по Петрову: 3 заявки, 15000₽     │ ← Итоги
├─────────────────────────────────────────┤
│ 👨‍🔧 Иванов Иван Иванович               │
│ Заявка #12  | ⚙️ IN_PROGRESS | Холод.  │
│ Заявка #25  | 🔒 CLOSED      | Духовка │
├─────────────────────────────────────────┤
│ Итого по Иванову: 2 заявки, 10000₽     │
└─────────────────────────────────────────┘
```

### Цветовое кодирование статусов:

- 🆕 **ASSIGNED** - белый фон
- ✅ **ACCEPTED** - белый фон
- ⚙️ **IN_PROGRESS** - желтый фон (в работе!)
- ✔️ **COMPLETED** - белый фон
- 🔒 **CLOSED** - зеленый фон (завершено!)
- ❌ **REFUSED** - красный фон (отказано!)

---

## 📊 Пример таблицы

### Мастер: Петров Петр Петрович

| ID | Статус | Тип | Клиент | Сумма | Материалы | Прибыль | Касса |
|----|--------|-----|--------|-------|-----------|---------|-------|
| 15 | ⚙️ IN_PROGRESS | Холодильник | Иванов | 5000₽ | 2000₽ | 2000₽ | 1000₽ |
| 18 | ✅ ACCEPTED | Стиралка | Петров | 0₽ | 0₽ | 0₽ | 0₽ |
| 22 | 🔒 CLOSED | Плита | Сидоров | 6000₽ | 1500₽ | 3000₽ | 1500₽ |
| **Итого** | | | | **11000₽** | **3500₽** | **5000₽** | **2500₽** |

### Мастер: Иванов Иван Иванович

| ID | Статус | Тип | Клиент | Сумма | Материалы | Прибыль | Касса |
|----|--------|-----|--------|-------|-----------|---------|-------|
| 12 | ⚙️ IN_PROGRESS | Холодильник | Смирнов | 0₽ | 0₽ | 0₽ | 0₽ |
| 25 | 🔒 CLOSED | Духовка | Козлов | 4000₽ | 1000₽ | 2000₽ | 1000₽ |
| **Итого** | | | | **4000₽** | **1000₽** | **2000₽** | **1000₽** |

---

## 🎯 Какие заявки включены

### Статусы:

✅ **ASSIGNED** - Назначена мастеру
✅ **ACCEPTED** - Принята мастером
✅ **IN_PROGRESS** - В работе
✅ **COMPLETED** - Выполнена
✅ **CLOSED** - Закрыта
✅ **REFUSED** - Отказана

❌ **NEW** - НЕ включены (еще не назначены)

### Сортировка:

1. По приоритету статуса:
   - IN_PROGRESS (в работе) - сначала!
   - ACCEPTED (принята)
   - ASSIGNED (назначена)
   - COMPLETED (выполнена)
   - CLOSED (закрыта)
   - REFUSED (отказана)

2. Внутри статуса - по дате создания (новые первые)

---

## 💰 Финансовые показатели

### Для каждой заявки:

- **Сумма** - общая сумма заказа
- **Материалы** - затраты на материалы
- **Прибыль мастера** - доход мастера
- **Сдача в кассу** - прибыль компании

### Для активных заявок (IN_PROGRESS, ASSIGNED):

- Показываются как 0₽ (еще не заполнены)
- Видно что заявка в работе

### Для закрытых заявок (CLOSED):

- Все финансовые данные заполнены
- Видна полная картина

---

## 📈 Итоги по мастеру

Под каждым мастером строка с итогами:

```
Итого по Петрову П.П.:
• Общая сумма: 15000₽
• Материалы: 5000₽
• Прибыль мастера: 7000₽
• Сдача в кассу: 3000₽
```

---

## 🔍 Дополнительная информация

### Колонка "Примечания":

Автоматически собирается из:
- Выезд за город (если есть)
- Есть отзыв (если есть)
- Запланированное время (если указано)
- Заметки по заявке (первые 50 символов)

**Пример:**
```
Выезд за город; Есть отзыв; Время: 14:00; Требуются запчасти
```

---

## 🎯 Для чего это нужно

### Контроль загрузки мастеров:

✅ Видно сколько заявок в работе
✅ Видно сколько принято
✅ Видно сколько закрыто

### Финансовый контроль:

✅ Общая сумма работ мастера
✅ Чистая прибыль
✅ Сколько должен сдать в кассу

### Планирование:

✅ Какие заявки активные
✅ Какие в приоритете (IN_PROGRESS)
✅ История закрытых заявок

### Аналитика:

✅ Эффективность каждого мастера
✅ Средний чек
✅ Загруженность

---

## 📱 Пример использования

### Сценарий 1: Проверка загрузки мастера

```
Открываете Excel → Лист "Заявки по мастерам"
Находите мастера Петрова
Видите:
- 3 заявки IN_PROGRESS ← Перегружен!
- 1 заявка ASSIGNED
- 5 заявок CLOSED

Вывод: Нужно перераспределить нагрузку
```

### Сценарий 2: Контроль финансов

```
Открываете Excel → Лист "Заявки по мастерам"
Смотрите итоги по мастеру:
- Сумма закрытых: 25000₽
- Прибыль мастера: 15000₽
- Сдача в кассу: 10000₽

Проверяете: мастер сдал деньги или нет
```

### Сценарий 3: Поиск конкретной заявки

```
Открываете Excel → Лист "Заявки по мастерам"
Ctrl+F → "Иванов" (клиент)
Находите заявку у конкретного мастера
Видите статус и все детали
```

---

## 🎓 Сравнение листов

### Лист "Статистика":
- Общие цифры
- Сводка по периоду

### Лист "Заказы":
- Все закрытые заявки
- Без группировки по мастерам

### Лист "Мастера":
- Статистика по каждому мастеру
- Итоговые цифры
- Без деталей заявок

### Лист "Заявки по мастерам" ✨ НОВЫЙ!
- **Детали каждой заявки**
- **Группировка по мастерам**
- **Активные + закрытые**
- **Полная картина**

---

## 📊 Структура данных

### Для каждого мастера:

```
👨‍🔧 Петров Петр Петрович
├── Активные заявки:
│   ├── #15 (IN_PROGRESS) - Холодильник - 5000₽
│   ├── #18 (ACCEPTED) - Стиралка - 0₽
│   └── #21 (ASSIGNED) - Плита - 0₽
│
├── Закрытые заявки:
│   ├── #10 (CLOSED) - Холодильник - 6000₽
│   ├── #14 (CLOSED) - Стиралка - 4000₽
│   └── #19 (CLOSED) - Плита - 5000₽
│
└── ИТОГО: 15000₽ (закрытые), 3 в работе
```

---

## ✅ Преимущества

### Для администратора:

✅ Полный контроль работы каждого мастера
✅ Видно загрузку в реальном времени
✅ Финансовый учет по каждому
✅ Быстрый поиск проблемных заявок

### Для бухгалтерии:

✅ Сколько должен сдать каждый мастер
✅ Разбивка по заявкам
✅ Проверка расчетов
✅ Контроль задолженностей

### Для менеджмента:

✅ КПИ каждого мастера
✅ Загруженность
✅ Эффективность
✅ Планирование ресурсов

---

## 🚀 Как использовать

### Ничего делать не нужно!

1. **Генерируется автоматически** при создании отчета
2. **Для всех мастеров** в системе
3. **Все их заявки** (активные и закрытые)

### Просто откройте Excel файл:

```bash
# Скачайте отчет (как обычно)
# Откройте в Excel
# Перейдите на лист "Заявки по мастерам"
# Вся информация уже там!
```

---

## 📊 Пример реального отчета

### Excel файл: report_daily_20251020.xlsx

**Лист "Заявки по мастерам":**

#### 👨‍🔧 Петров Петр Петрович

| ID | Статус | Тип | Клиент | Адрес | Телефон | Сумма | Материалы | Прибыль | Касса |
|----|--------|-----|--------|-------|---------|-------|-----------|---------|-------|
| 15 | ⚙️ IN_PROGRESS | Холодильник Samsung | Иванов И. | ул. Ленина 1 | 799912... | 0₽ | 0₽ | 0₽ | 0₽ |
| 18 | ✅ ACCEPTED | Стиралка LG | Петров П. | ул. Мира 5 | 799923... | 0₽ | 0₽ | 0₽ | 0₽ |
| 22 | 🔒 CLOSED | Плита Gorenje | Сидоров С. | пр. Победы 10 | 799934... | 6000₽ | 1500₽ | 3000₽ | 1500₽ |
| 10 | 🔒 CLOSED | Холодильник Indesit | Козлов К. | ул. Пушкина 3 | 799945... | 5000₽ | 1000₽ | 2500₽ | 1500₽ |

**Итого по Петрову П.П.:** Сумма: 11000₽ | Материалы: 2500₽ | Прибыль: 5500₽ | Касса: 3000₽

#### 👨‍🔧 Иванов Иван Иванович

| ID | Статус | Тип | Клиент | Адрес | Телефон | Сумма | Материалы | Прибыль | Касса |
|----|--------|-----|--------|-------|---------|-------|-----------|---------|-------|
| 12 | ⚙️ IN_PROGRESS | Холодильник | Смирнов | ул. Гагарина 7 | 799956... | 0₽ | 0₽ | 0₽ | 0₽ |
| 25 | 🔒 CLOSED | Духовка | Новиков | ул. Советская 12 | 799967... | 4000₽ | 1000₽ | 2000₽ | 1000₽ |

**Итого по Иванову И.И.:** Сумма: 4000₽ | Материалы: 1000₽ | Прибыль: 2000₽ | Касса: 1000₽

---

## 🔧 Технические детали

### Реализация:

1. **Получение мастеров** из списка в отчете
2. **Для каждого мастера:**
   - Запрос всех его заявок (ASSIGNED to CLOSED)
   - Сортировка по приоритету статуса
   - Добавление в таблицу
3. **Подсчет итогов** по каждому мастеру
4. **Форматирование** с цветами и стилями

### SQL запрос:

```sql
SELECT
    o.id,
    o.status,
    o.equipment_type,
    o.client_name,
    o.total_amount,
    o.master_profit,
    o.company_profit,
    ...
FROM orders o
WHERE o.assigned_master_id = ?
    AND o.status IN ('ASSIGNED', 'ACCEPTED', 'IN_PROGRESS', 'COMPLETED', 'CLOSED', 'REFUSED')
ORDER BY
    CASE o.status
        WHEN 'IN_PROGRESS' THEN 1  -- Сначала в работе
        WHEN 'ACCEPTED' THEN 2
        ...
    END,
    o.created_at DESC
```

---

## 💡 Полезные функции Excel

### Фильтры:

1. Включите автофильтр (Данные → Фильтр)
2. Фильтруйте по:
   - Мастеру
   - Статусу
   - Типу техники
   - Сумме

### Сортировка:

- По сумме (найти самые дорогие)
- По дате (найти старые)
- По статусу (найти активные)

### Поиск:

- Ctrl+F → найти клиента
- Ctrl+F → найти номер заявки
- Ctrl+F → найти адрес

---

## 📋 Что видно в отчете

### Для каждого мастера:

1. **Активные заявки:**
   - Сколько заявок в работе
   - Что делает прямо сейчас
   - Приоритетные задачи

2. **Закрытые заявки:**
   - Что уже выполнил
   - Сколько заработал
   - Сколько должен сдать

3. **Итоги:**
   - Общая сумма всех заказов
   - Расходы на материалы
   - Прибыль мастера
   - Сдача в кассу компании

---

## ✅ Итого

**Новый лист "Заявки по мастерам" дает:**

- ✅ Полную картину работы каждого мастера
- ✅ Все заявки (активные + закрытые)
- ✅ Детальную финансовую информацию
- ✅ Удобную группировку и итоги
- ✅ Цветовое кодирование статусов
- ✅ Примечания и доп. информацию

**Автоматически в каждом отчете!** 🎉

---

**Дата:** 20.10.2025
**Версия:** 2.2
**Статус:** ✅ Готово к использованию
