# Диаграмма архитектуры: Telegram Repair Bot

## 1. Компонентная диаграмма

```
┌─────────────────────────────────────────────────────────────────────┐
│                         TELEGRAM PLATFORM                           │
└────────────────────────────────┬────────────────────────────────────┘
                                 │ Long Polling
                                 │ (Updates via HTTPS)
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         TELEGRAM BOT (bot.py)                       │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │  Bot Instance    │  │   Dispatcher     │  │  FSM Storage     │  │
│  │  (aiogram 3.16)  │◄─┤  (Router Chain)  │◄─┤  (Memory/Redis)  │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                    ┌────────────┼────────────┐
                    │            │            │
                    ▼            ▼            ▼
         ┌──────────────┐ ┌──────────┐ ┌──────────────┐
         │   Logging    │ │   Role   │ │    Error     │
         │  Middleware  │ │  Check   │ │   Handler    │
         └──────────────┘ └──────────┘ └──────────────┘
                    │            │            │
                    └────────────┼────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │                         │
                    ▼                         ▼
         ┌──────────────────┐      ┌──────────────────┐
         │    HANDLERS      │      │    SERVICES      │
         ├──────────────────┤      ├──────────────────┤
         │ • admin.py       │◄─────┤ • scheduler.py   │
         │ • dispatcher.py  │      │ • reports.py     │
         │ • master.py      │      │ • excel_export.py│
         │ • common.py      │      │ • notifier.py    │
         │ • group_*.py     │      └────────┬─────────┘
         │ • financial_*.py │               │
         └────────┬─────────┘               │
                  │                         │
                  └──────────┬──────────────┘
                             │
                             ▼
                  ┌──────────────────┐
                  │    DATABASE      │
                  ├──────────────────┤
                  │ • db.py (async)  │
                  │ • models.py      │
                  │ • schemas.py     │
                  └────────┬─────────┘
                           │
                           ▼
                  ┌──────────────────┐
                  │  SQLite / PG     │
                  │  bot_database.db │
                  └──────────────────┘
```

---

## 2. Диаграмма потока данных (Order Creation)

```
    ПОЛЬЗОВАТЕЛЬ                  БОТ                      БД
         │                         │                        │
         │──── /create_order ─────►│                        │
         │                         │                        │
         │                         ├──[Middleware: RoleCheck]
         │                         │   check_role()         │
         │                         │◄───────────────────────┤
         │                         │  get_or_create_user()  │
         │                         │                        │
         │◄── FSM: Equipment ──────┤                        │
         │                         │                        │
         │──── "Стиральная" ───────►│                        │
         │                         ├──[Set State]           │
         │                         │  OrderState.description│
         │                         │                        │
         │◄── FSM: Description ────┤                        │
         │                         │                        │
         │──── "Не включается" ────►│                        │
         │                         ├──[Set State]           │
         │                         │  OrderState.client_name│
         │                         │                        │
         │◄── FSM: Client Name ────┤                        │
         │                         │                        │
         │──── "Иван Петров" ──────►│                        │
         │          ...            │          ...           │
         │                         │                        │
         │──── "Подтвердить" ──────►│                        │
         │                         │                        │
         │                         ├──[Validate]            │
         │                         │  Pydantic Schema       │
         │                         │                        │
         │                         ├──[Create Order]────────►│
         │                         │  create_order()        │
         │                         │◄───────────────────────┤
         │                         │  Order ID: 123         │
         │                         │                        │
         │                         ├──[Notify]              │
         │                         │  admins/dispatchers    │
         │                         │                        │
         │◄── "✅ Заявка #123" ────┤                        │
         │      создана"           │                        │
         │                         │                        │
```

---

## 3. Архитектура ролей и доступа

```
┌───────────────────────────────────────────────────────────────────┐
│                          USER HIERARCHY                           │
└───────────────────────────────────────────────────────────────────┘

     ┌──────────────────────────────────────────────┐
     │              ADMIN (Full Access)             │
     ├──────────────────────────────────────────────┤
     │ • Управление пользователями                  │
     │ • Управление мастерами (approve/reject)      │
     │ • Все операции над заявками                  │
     │ • Финансовые отчёты                          │
     │ • Статистика и аудит                         │
     │ • System configuration                       │
     └────────────────┬─────────────────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ▼                           ▼
┌───────────────────┐      ┌────────────────────┐
│    DISPATCHER     │      │      MASTER        │
├───────────────────┤      ├────────────────────┤
│ • Создание заявок │      │ • Просмотр своих   │
│ • Назначение      │      │   заявок           │
│   мастеров        │      │ • Принятие/отказ   │
│ • Изменение       │      │ • Смена статуса    │
│   статуса         │      │ • Закрытие заявки  │
│ • Редактирование  │      │ • Перенос          │
│   заявок          │      │ • DR режим         │
└───────────────────┘      └────────────────────┘
        │                           │
        └─────────────┬─────────────┘
                      │
                      ▼
            ┌──────────────────┐
            │     UNKNOWN      │
            ├──────────────────┤
            │ • Только /start  │
            │ • Ограниченный   │
            │   доступ         │
            └──────────────────┘

⚠️ МНОЖЕСТВЕННЫЕ РОЛИ: Пользователь может иметь несколько ролей
   Пример: "ADMIN,DISPATCHER" → полный доступ + создание заявок
```

---

## 4. State Machine заявки

```
┌────────────────────────────────────────────────────────────────────┐
│                      ORDER LIFECYCLE                               │
└────────────────────────────────────────────────────────────────────┘

                    ┌──────────────┐
                    │     NEW      │ ◄── Создана диспетчером
                    └──────┬───────┘
                           │
                  ┌────────┴────────┐
                  │ Назначить       │
                  │ мастера         │
                  └────────┬────────┘
                           │
                    ┌──────▼───────┐
                    │   ASSIGNED   │ ◄── Назначена мастеру
                    └──────┬───────┘
                           │
              ┌────────────┼────────────┐
              │                         │
              ▼                         ▼
       ┌────────────┐            ┌────────────┐
       │  REFUSED   │            │  ACCEPTED  │ ◄── Мастер принял
       └────────────┘            └──────┬─────┘
          │                             │
          │ (Заявка возвращается)       │
          │                             │
          │                      ┌──────▼──────┐
          │                      │   ONSITE    │ ◄── Мастер на объекте
          │                      └──────┬──────┘
          │                             │
          │                    ┌────────┼────────┐
          │                    │                 │
          │                    ▼                 ▼
          │              ┌───────────┐     ┌──────────┐
          └──────────────┤  CLOSED   │     │    DR    │ ◄── Длительный
                         │ (Финансы) │     │ (Ожидает)│     ремонт
                         └───────────┘     └──────────┘

Легенда:
────► Основной переход
═══► Альтернативный путь
```

---

## 5. Диаграмма планировщика задач

```
┌───────────────────────────────────────────────────────────────────┐
│                    APScheduler (AsyncIOScheduler)                 │
└───────────────────────────────────────────────────────────────────┘

┌─────────────────────┐
│ CRON JOBS (время)   │
├─────────────────────┤
│ 08:00 daily         │──► send_daily_report()
│ 09:00 daily         │──► send_daily_summary()
│ Mon 09:00           │──► send_weekly_report()
│ 1st 10:00           │──► send_monthly_report()
└─────────────────────┘

┌─────────────────────┐
│ INTERVAL JOBS       │
├─────────────────────┤
│ Every 30 min        │──► check_order_sla()
│ Every 5 min         │──► remind_assigned_orders()
│ Every 5 min         │──► remind_unassigned_orders()
└─────────────────────┘

                           │
                           ▼
                  ┌─────────────────┐
                  │  Notifications  │
                  ├─────────────────┤
                  │ • Telegram msgs │
                  │ • Excel reports │
                  │ • Alerts        │
                  └─────────────────┘
```

---

## 6. Deployment архитектура

```
┌───────────────────────────────────────────────────────────────────┐
│                       PRODUCTION DEPLOYMENT                       │
└───────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          DOCKER HOST                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         telegram_repair_bot (Container)                  │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │  Python 3.11-slim                                        │  │
│  │  User: botuser (non-root)                                │  │
│  │  Healthcheck: DB file exists                             │  │
│  │                                                           │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐         │  │
│  │  │   bot.py   │  │ APScheduler│  │   Logging  │         │  │
│  │  └────────────┘  └────────────┘  └────────────┘         │  │
│  └──────────────────────────────────────────────────────────┘  │
│         │                    │                    │             │
│         │ Volume mounts      │                    │             │
│         │                    │                    │             │
│  ┌──────▼──────┐      ┌──────▼──────┐     ┌──────▼──────┐     │
│  │    data/    │      │    logs/    │     │  backups/   │     │
│  │ (SQLite DB) │      │ (Rotated)   │     │  (Scheduled)│     │
│  └─────────────┘      └─────────────┘     └─────────────┘     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ Bridge Network
                            │
          ┌─────────────────┼─────────────────┐
          │                                    │
          ▼                                    ▼
   ┌──────────────┐                    ┌──────────────┐
   │   Redis      │ (Planned)          │  PostgreSQL  │ (Recommended)
   │  (FSM Store) │                    │     (DB)     │
   └──────────────┘                    └──────────────┘
```

---

## 7. Интеграционная диаграмма

```
┌───────────────────────────────────────────────────────────────────┐
│                      EXTERNAL INTEGRATIONS                        │
└───────────────────────────────────────────────────────────────────┘

              ┌────────────────────────┐
              │   Telegram Bot API     │
              │  api.telegram.org      │
              └──────────┬─────────────┘
                         │ HTTPS
                         │ Long Polling
                         │
                         ▼
              ┌────────────────────────┐
              │   Repair Bot           │
              │   (Core System)        │
              └────┬─────────────┬─────┘
                   │             │
       ┌───────────┘             └───────────┐
       │                                     │
       ▼                                     ▼
┌─────────────────┐                   ┌─────────────────┐
│     Sentry      │ (Error Tracking)  │   Prometheus    │ (Metrics)
│  sentry.io      │                   │   (Optional)    │
└─────────────────┘                   └─────────────────┘

     Planned Integrations:
     ┌─────────────────┐
     │   Payment API   │ (Онлайн оплата)
     │  (Stripe/Yookassa)
     └─────────────────┘

     ┌─────────────────┐
     │   CRM System    │ (Синхронизация)
     │   (1C, amoCRM)  │
     └─────────────────┘

     ┌─────────────────┐
     │   SMS Gateway   │ (Уведомления)
     │  (Twilio/SMSC)  │
     └─────────────────┘
```

---

## 8. Критичные точки отказа

```
┌───────────────────────────────────────────────────────────────────┐
│                      FAILURE POINTS                               │
└───────────────────────────────────────────────────────────────────┘

❌ SINGLE POINTS OF FAILURE:

1. SQLite Database
   ┌─────────────────────┐
   │  bot_database.db    │ ◄── Единственная копия
   │  (File on disk)     │     Нет репликации
   └─────────────────────┘     Риск: File corruption

2. MemoryStorage (FSM)
   ┌─────────────────────┐
   │   In-Memory State   │ ◄── Пропадает при рестарте
   │   (RAM)             │     Пользователи теряют прогресс
   └─────────────────────┘

3. Bot Process
   ┌─────────────────────┐
   │   Single Process    │ ◄── Нет High Availability
   │   (bot.py)          │     Restart = downtime
   └─────────────────────┘

4. Telegram API
   ┌─────────────────────┐
   │  api.telegram.org   │ ◄── Внешняя зависимость
   │  (External)         │     Нет fallback
   └─────────────────────┘

✅ MITIGATIONS:

• PostgreSQL + репликация
• Redis для FSM (персистентность)
• K8s Deployment (multi-replica)
• Retry механизм для API calls
• Circuit breaker pattern
```

---

## Условные обозначения

```
┌─────┐
│  □  │  Компонент/Модуль
└─────┘

  ──►   Поток данных / Вызов

  ◄──   Ответ

  ═══►  Альтернативный путь

  ┬ ┴   Разветвление

  ▼ ▲   Направление потока
```

---

**Версия диаграммы:** 1.0
**Дата:** 19 октября 2025
**Автор:** Ведущий инженер-аудитор

