# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Retry –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è Bot API

## üìã –û–±–∑–æ—Ä

–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è retry –º–µ—Ö–∞–Ω–∏–∑–º–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff –¥–ª—è –≤—Å–µ—Ö Bot API –∑–∞–ø—Ä–æ—Å–æ–≤.
–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –¥–æ—Å—Ç–∞–≤–∫—É –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤ —Å–µ—Ç–∏/API.

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. Retry –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä (`app/utils/retry.py`)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff (1s ‚Üí 2s ‚Üí 4s ‚Üí ...)
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60 —Å–µ–∫—É–Ω–¥)
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)
- ‚úÖ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ `TelegramRetryAfter` (429 Too Many Requests)
- ‚úÖ –†–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É retryable –∏ non-retryable –æ—à–∏–±–∫–∞–º–∏
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏

**–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ –æ—à–∏–±–∫–∏:**

**RETRYABLE** (–ø–æ–≤—Ç–æ—Ä—è–µ–º):
- `TelegramNetworkError` - —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
- `TelegramServerError` - –æ—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ Telegram (5xx)
- `TelegramRetryAfter` - –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ (429)

**NON-RETRYABLE** (–Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º):
- `TelegramBadRequest` - –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å
- `TelegramNotFound` - —á–∞—Ç/—Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
- `TelegramUnauthorizedError` - –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω
- `TelegramConflictError` - –∫–æ–Ω—Ñ–ª–∏–∫—Ç (–±–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω)
- `TelegramForbiddenError` - –±–æ—Ç –∫–∏–∫–Ω—É—Ç –∏–∑ —á–∞—Ç–∞
- `TelegramEntityTooLarge` - —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π

### 2. –ì–æ—Ç–æ–≤—ã–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### `safe_send_message()`
```python
await safe_send_message(
    bot,
    chat_id,
    "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
    parse_mode="HTML",
    max_attempts=5  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
)
```

#### `safe_answer_callback()`
```python
await safe_answer_callback(
    callback_query,
    "–û—Ç–≤–µ—Ç",
    show_alert=True
)
```

#### `safe_edit_message()`
```python
await safe_edit_message(
    message,
    "–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç",
    parse_mode="HTML"
)
```

#### `safe_delete_message()`
```python
await safe_delete_message(
    bot,
    chat_id,
    message_id
)
```

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö

#### Scheduler (–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á)
- ‚úÖ SLA —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º (5 –ø–æ–ø—ã—Ç–æ–∫)
- ‚úÖ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞ (5 –ø–æ–ø—ã—Ç–æ–∫)
- ‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞–º –æ –Ω–µ–ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–∫–∞—Ö (5 –ø–æ–ø—ã—Ç–æ–∫)

**–§–∞–π–ª:** `app/services/scheduler.py`

#### Dispatcher handlers
- ‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞ –∑–∞—è–≤–∫—É (5 –ø–æ–ø—ã—Ç–æ–∫)
- ‚úÖ –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ (5 –ø–æ–ø—ã—Ç–æ–∫)
- ‚úÖ –°–Ω—è—Ç–∏–µ –º–∞—Å—Ç–µ—Ä–∞ —Å –∑–∞—è–≤–∫–∏ (3 –ø–æ–ø—ã—Ç–∫–∏)
- ‚úÖ –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ (3 –ø–æ–ø—ã—Ç–∫–∏)

**–§–∞–π–ª:** `app/handlers/dispatcher.py`

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **–°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:** 2
  - `app/utils/retry.py` (308 —Å—Ç—Ä–æ–∫)
  - `app/utils/__init__.py` (45 —Å—Ç—Ä–æ–∫)

- **–ò–∑–º–µ–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:** 2
  - `app/services/scheduler.py` (–∑–∞–º–µ–Ω–µ–Ω–æ 3 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —É—á–∞—Å—Ç–∫–∞)
  - `app/handlers/dispatcher.py` (–∑–∞–º–µ–Ω–µ–Ω–æ 5 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤)

- **–ü–æ–∫—Ä—ã—Ç–∏–µ:** –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ Bot API –≤—ã–∑–æ–≤—ã

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- **–î–æ:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å ‚Üí –ú–∞—Å—Ç–µ—Ä –Ω–µ —É–∑–Ω–∞–ª –æ –∑–∞—è–≤–∫–µ ‚Üí –ó–∞—è–≤–∫–∞ –ø–æ–≤–∏—Å–ª–∞
- **–ü–æ—Å–ª–µ:** –î–æ 5 –ø–æ–ø—ã—Ç–æ–∫ —Å —É–º–Ω—ã–º backoff ‚Üí –î–æ—Å—Ç–∞–≤–∫–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞

### 2. Flood Control (429)
- **–î–æ:** –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å –ø–∞–¥–∞–ª
- **–ü–æ—Å–ª–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ `retry_after` —Å–µ–∫—É–Ω–¥ –æ—Ç Telegram

### 3. –°–µ—Ç–µ–≤—ã–µ —Å–±–æ–∏
- **–î–æ:** –í—Ä–µ–º–µ–Ω–Ω—ã–π —Å–±–æ–π —Å–µ—Ç–∏ ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ
- **–ü–æ—Å–ª–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

### 4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–î–æ:** –ë—ã—Å—Ç—Ä—ã–µ fail –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
- **–ü–æ—Å–ª–µ:** –£–º–Ω—ã–π retry —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫

### 5. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```
WARNING: send_notification: TelegramNetworkError occurred. Attempt 1/5. Error: ...
INFO: Retrying in 1.00 seconds...
WARNING: send_notification: TelegramNetworkError occurred. Attempt 2/5. Error: ...
INFO: Retrying in 2.00 seconds...
INFO: SUCCESS: Notification sent to group 12345
```

## üìà –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã

### –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏
```
[INFO] Attempting to send notification to group -1001234567890
[INFO] Notification text prepared: 456 chars
[INFO] SUCCESS: Notification sent to group -1001234567890
```

### Retry –ø—Ä–∏ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ
```
[INFO] Attempting to send notification to group -1001234567890
[WARNING] send_notification: TelegramNetworkError occurred. Attempt 1/5. Error: Connection timeout
[INFO] Retrying in 1.00 seconds...
[WARNING] send_notification: TelegramNetworkError occurred. Attempt 2/5. Error: Connection timeout
[INFO] Retrying in 2.00 seconds...
[INFO] SUCCESS: Notification sent to group -1001234567890
```

### Flood Control (429)
```
[INFO] Attempting to send notification to group -1001234567890
[WARNING] safe_send_message: Flood control exceeded (429). Retry after 30 seconds. Attempt 1/5
[INFO] Waiting 30 seconds before retry...
[INFO] SUCCESS: Notification sent to group -1001234567890
```

### Non-retryable –æ—à–∏–±–∫–∞
```
[INFO] Attempting to send notification to group -1001234567890
[ERROR] safe_send_message: Non-retryable error TelegramForbiddenError: Bot was kicked from chat. Not retrying.
```

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –Ω–æ–≤–æ–º –∫–æ–¥–µ

### –° –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º
```python
from app.utils import retry_on_telegram_error

@retry_on_telegram_error(max_attempts=5, base_delay=1.0)
async def my_notification_function(bot, chat_id, text):
    return await bot.send_message(chat_id, text, parse_mode="HTML")

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
result = await my_notification_function(bot, 12345, "Hello!")
if result is None:
    logger.error("Failed to send after all retries")
```

### –° –≥–æ—Ç–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π
```python
from app.utils import safe_send_message

# –ü—Ä–æ—Å—Ç–æ–π –≤—ã–∑–æ–≤
result = await safe_send_message(
    bot,
    chat_id=12345,
    text="Hello World!",
    parse_mode="HTML",
    max_attempts=3  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, default 3
)

# –° –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
from aiogram.types import InlineKeyboardMarkup

result = await safe_send_message(
    bot,
    chat_id=12345,
    text="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
    reply_markup=keyboard,
    max_attempts=5
)
```

## üõ°Ô∏è –ì–∞—Ä–∞–Ω—Ç–∏–∏

1. **–ö—Ä–∏—Ç–∏—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è** - –¥–æ 5 –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –≤–∞–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
2. **–ó–∞—â–∏—Ç–∞ –æ—Ç flood** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏ 429
3. **–≠–∫–æ–Ω–æ–º–∏—è API –∑–∞–ø—Ä–æ—Å–æ–≤** - –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º non-retryable –æ—à–∏–±–∫–∏
4. **–î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏** - –≤–∏–¥–∏–º –∫–∞–∂–¥—É—é –ø–æ–ø—ã—Ç–∫—É –∏ –ø—Ä–∏—á–∏–Ω—É –Ω–µ—É–¥–∞—á–∏
5. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞** - –º–∞—Å—Ç–µ—Ä–∞ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∞—Ö

## üìù –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ø—ã—Ç–æ–∫
```python
# –î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
await safe_send_message(bot, chat_id, text, max_attempts=5)

# –î–ª—è –º–µ–Ω–µ–µ –≤–∞–∂–Ω—ã—Ö
await safe_send_message(bot, chat_id, text, max_attempts=2)
```

### –ö–∞—Å—Ç–æ–º–Ω—ã–π –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä
```python
@retry_on_telegram_error(
    max_attempts=10,        # –±–æ–ª—å—à–µ –ø–æ–ø—ã—Ç–æ–∫
    base_delay=2.0,         # –¥–æ–ª—å—à–µ –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
    max_delay=120.0,        # –º–∞–∫—Å–∏–º—É–º 2 –º–∏–Ω—É—Ç—ã –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
    exponential_base=3.0    # –±—ã—Å—Ç—Ä–µ–µ —Ä–∞—Å—Ç–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∞
)
async def my_function():
    pass
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–ü—Ä–æ–±–ª–µ–º–∞ #7 –∏–∑ –∞—É–¥–∏—Ç–∞ –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–ê**

- ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –≤—Å–µ—Ö Bot API –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ Telegram –æ—à–∏–±–æ–∫
- ‚úÖ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è 429 (Flood Control)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫–æ –≤—Å–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–º –º–µ—Å—Ç–∞–º
- ‚úÖ –ì–æ—Ç–æ–≤—ã–µ helper —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –ù—É–ª–µ–≤—ã—Ö linter –æ—à–∏–±–æ–∫
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## üéØ –í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:** üü° –°–†–ï–î–ù–Ø–Ø  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** –í–´–°–û–ö–ò–ô (—Å–≤—è–∑–∞–Ω–æ —Å —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å—é –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–®–ï–ù–û

**–ü–æ–ª—å–∑–∞ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞:**
- –ú–∞—Å—Ç–µ—Ä–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞—è–≤–∫–∞—Ö
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Å—Ç–∞–µ—Ç—Å—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–π (–∑–∞—è–≤–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ = –º–∞—Å—Ç–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω)
- –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤ —Å–µ—Ç–∏/API
- –ó–∞—â–∏—Ç–∞ –æ—Ç flood control (429)
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞: 2025-10-12*  
*–í–µ—Ä—Å–∏—è: 1.0*  
*–ê–≤—Ç–æ—Ä: AI Assistant*

