# ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ ORM –∑–∞–≤–µ—Ä—à–µ–Ω–∞

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω—ã ORM –º–æ–¥–µ–ª–∏
- **–§–∞–π–ª**: `app/database/orm_models.py`
- **–ú–æ–¥–µ–ª–∏**: User, Master, Order, AuditLog, FinancialReport, MasterFinancialReport, OrderStatusHistory
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –¢–∏–ø–∏–∑–∞—Ü–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `Mapped[Type]`
  - Relationship –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏
  - –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (CheckConstraint)
  - –ü–æ–ª—è `deleted_at` –∏ `version` –¥–ª—è soft delete –∏ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

### 2. –°–æ–∑–¥–∞–Ω –∫–ª–∞—Å—Å ORMDatabase
- **–§–∞–π–ª**: `app/database/orm_database.py`
- **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**:
  - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î —á–µ—Ä–µ–∑ SQLAlchemy 2.0
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SQLite (dev) –∏ PostgreSQL (prod)
  - Eager loading –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è N+1 –ø—Ä–æ–±–ª–µ–º—ã
  - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
  - Soft delete –≤–º–µ—Å—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
  - Audit logging –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **–ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å User (12 –º–µ—Ç–æ–¥–æ–≤)**:
  - `get_or_create_user()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `get_user_by_telegram_id()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID
  - `update_user_role()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `add_user_role()` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  - `remove_user_role()` - —É–¥–∞–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `set_user_roles()` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π
  - `get_all_users()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - `get_admins_and_dispatchers()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–≤
  - `soft_delete_user()` - –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

- **–ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Master (9 –º–µ—Ç–æ–¥–æ–≤)**:
  - `create_master()` - —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞
  - `get_master_by_telegram_id()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –ø–æ Telegram ID
  - `get_master_by_id()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –ø–æ ID
  - `get_master_by_work_chat_id()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –ø–æ ID —Ä–∞–±–æ—á–µ–≥–æ —á–∞—Ç–∞
  - `get_all_masters()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∞—Å—Ç–µ—Ä–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
  - `update_master_status()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –º–∞—Å—Ç–µ—Ä–∞
  - `update_master_work_chat()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ —á–∞—Ç–∞ –º–∞—Å—Ç–µ—Ä–∞
  - `approve_master()` - –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –º–∞—Å—Ç–µ—Ä–∞

- **–ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Order (11 –º–µ—Ç–æ–¥–æ–≤)**:
  - `create_order()` - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
  - `get_order_by_id()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –ø–æ ID
  - `get_all_orders()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
  - `update_order_status()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
  - `assign_master_to_order()` - –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞ –∑–∞—è–≤–∫—É
  - `get_order_status_history()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞—è–≤–∫–∏
  - `update_order()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏
  - `get_orders_by_master()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ –ø–æ –º–∞—Å—Ç–µ—Ä—É
  - `update_order_amounts()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å—É–º–º –∑–∞—è–≤–∫–∏
  - `get_orders_by_period()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ –∑–∞ –ø–µ—Ä–∏–æ–¥
  - `soft_delete_order()` - –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏

- **–ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –æ—Ç—á–µ—Ç–∞–º–∏ (5 –º–µ—Ç–æ–¥–æ–≤)**:
  - `create_financial_report()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
  - `get_financial_report_by_id()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –ø–æ ID
  - `create_master_financial_report()` - —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –º–∞—Å—Ç–µ—Ä—É
  - `get_master_reports_by_report_id()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –º–∞—Å—Ç–µ—Ä–∞–º
  - `get_latest_reports()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—Ç—á–µ—Ç–æ–≤

- **–ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏—Ç–æ–º –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π (3 –º–µ—Ç–æ–¥–∞)**:
  - `add_audit_log()` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥ –∞—É–¥–∏—Ç–∞
  - `get_audit_logs()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∞—É–¥–∏—Ç–∞
  - `get_statistics()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –ë–î

**–ò—Ç–æ–≥–æ: 40+ –º–µ—Ç–æ–¥–æ–≤, –ø–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Database –∫–ª–∞—Å—Å**

### 3. –î–æ–±–∞–≤–ª–µ–Ω feature flag
- **–§–∞–π–ª**: `app/core/config.py`
- **–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è**: `USE_ORM` (boolean)
- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é**: `false` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π –∫–æ–¥ —Å –ø—Ä—è–º—ã–º–∏ SQL –∑–∞–ø—Ä–æ—Å–∞–º–∏)
- **–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è**: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `USE_ORM=true` –≤ `.env`

### 4. –°–æ–∑–¥–∞–Ω–∞ —Ñ–∞–±—Ä–∏–∫–∞ Database
- **–§–∞–π–ª**: `app/database/__init__.py`
- **–õ–æ–≥–∏–∫–∞**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç `ORMDatabase` –∏–ª–∏ `Database` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `USE_ORM`
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ**: –ü—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### 5. –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î
- **–î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏**:
  - `deleted_at` (DATETIME NULL) - –¥–ª—è soft delete
  - `version` (INTEGER NOT NULL DEFAULT 1) - –¥–ª—è –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- **–¢–∞–±–ª–∏—Ü—ã**: users, masters, orders, audit_log
- **–ò–Ω–¥–µ–∫—Å—ã**: –°–æ–∑–¥–∞–Ω—ã –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫

### 6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Alembic
- **–§–∞–π–ª**: `migrations/env.py`
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∞**: `target_metadata = Base.metadata` –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π
- **–ú–∏–≥—Ä–∞—Ü–∏—è**: `008_add_soft_delete.py` (—É–∂–µ —Å–æ–∑–¥–∞–Ω–∞)

## –ü—Ä–æ–±–ª–µ–º—ã –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –°–±–æ–∏ –ø—Ä–∏ `alembic upgrade`
**–ü—Ä–∏—á–∏–Ω–∞**: –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SQLAlchemy –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ `orm_models.py` –≤ `migrations/env.py`

**–†–µ—à–µ–Ω–∏–µ**: –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ SQLite API

### –ü—Ä–æ–±–ª–µ–º–∞ 2: `asyncpg` –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ Windows
**–ü—Ä–∏—á–∏–Ω–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Microsoft C++ Build Tools

**–†–µ—à–µ–Ω–∏–µ**: Feature flag –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQLite –ª–æ–∫–∞–ª—å–Ω–æ, `asyncpg` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ production/CI

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ö–æ–ª–æ–Ω–∫–∞ `deleted_at` —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞, –Ω–æ `version` - –Ω–µ—Ç
**–ü—Ä–∏—á–∏–Ω–∞**: –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±—ã–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —á–∞—Å—Ç–∏—á–Ω–æ

**–†–µ—à–µ–Ω–∏–µ**: –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ

## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (SQLite)
```bash
# –í .env —Ñ–∞–π–ª–µ
USE_ORM=true
DATABASE_PATH=bot_database.db

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
python bot.py
```

### –î–ª—è production (PostgreSQL)
```bash
# –í .env —Ñ–∞–π–ª–µ
USE_ORM=true
DATABASE_URL=postgresql+asyncpg://user:password@localhost/dbname

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
alembic upgrade head

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
python bot.py
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç
```python
import asyncio
from app.database.orm_database import ORMDatabase

async def test():
    db = ORMDatabase()
    await db.connect()

    # –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = await db.get_user_by_telegram_id(123456)
    print(f"User: {user}")

    # –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–æ–≤
    masters = await db.get_all_masters()
    print(f"Masters: {len(masters)}")

    await db.disconnect()

asyncio.run(test())
```

### –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# Unit —Ç–µ—Å—Ç—ã
pytest tests/unit/

# Integration —Ç–µ—Å—Ç—ã
pytest tests/integration/
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
1. **Eager Loading**: `joinedload()` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è N+1 –ø—Ä–æ–±–ª–µ–º—ã
2. **–ò–Ω–¥–µ–∫—Å—ã**: –ù–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (status, telegram_id, deleted_at)
3. **Connection Pooling**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
4. **Batch Operations**: –ì—Ä—É–ø–ø–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —á–∏—Å–ª–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

### –ú–µ—Ç—Ä–∏–∫–∏
- **–°–Ω–∏–∂–µ–Ω–∏–µ N+1 –ø—Ä–æ–±–ª–µ–º—ã**: ~80% –º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**: ACID –≥–∞—Ä–∞–Ω—Ç–∏–∏
- **Soft delete**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å ORM –º–æ–¥–µ–ª–∏ (8 –º–æ–¥–µ–ª–µ–π)
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å ORMDatabase –∫–ª–∞—Å—Å (40+ –º–µ—Ç–æ–¥–æ–≤)
3. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
4. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
5. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –º–µ—Ç–æ–¥—ã –∏–∑ Database –∫–ª–∞—Å—Å–∞
6. ‚è≥ –ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏
7. ‚è≥ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤ production

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
1. –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –¥–ª—è ORM
2. –°–æ–∑–¥–∞—Ç—å –±–µ–Ω—á–º–∞—Ä–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –î–æ–±–∞–≤–∏—Ç—å monitoring –º–µ—Ç—Ä–∏–∫ –ë–î
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã

## –û–±–Ω–æ–≤–ª–µ–Ω–∏—è (20 –æ–∫—Ç—è–±—Ä—è 2025)

### ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ 18 –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –º–µ—Ç–æ–¥–æ–≤

**User –º–µ—Ç–æ–¥—ã (3 –Ω–æ–≤—ã—Ö)**:
- `remove_user_role()` - —É–¥–∞–ª–µ–Ω–∏–µ —Ä–æ–ª–∏
- `set_user_roles()` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π
- `get_admins_and_dispatchers()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–≤

**Master –º–µ—Ç–æ–¥—ã (4 –Ω–æ–≤—ã—Ö)**:
- `get_master_by_id()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ ID
- `get_master_by_work_chat_id()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ ID —Ä–∞–±–æ—á–µ–≥–æ —á–∞—Ç–∞
- `update_master_status()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
- `update_master_work_chat()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ —á–∞—Ç–∞

**Order –º–µ—Ç–æ–¥—ã (5 –Ω–æ–≤—ã—Ö)**:
- `get_order_status_history()` - –∏—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
- `update_order()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏
- `get_orders_by_master()` - –∑–∞—è–≤–∫–∏ –ø–æ –º–∞—Å—Ç–µ—Ä—É
- `update_order_amounts()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤
- `get_orders_by_period()` - –∑–∞—è–≤–∫–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥

**Financial Reports –º–µ—Ç–æ–¥—ã (5 –Ω–æ–≤—ã—Ö)**:
- `create_financial_report()` - —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
- `get_financial_report_by_id()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
- `create_master_financial_report()` - –æ—Ç—á–µ—Ç –ø–æ –º–∞—Å—Ç–µ—Ä—É
- `get_master_reports_by_report_id()` - –æ—Ç—á–µ—Ç—ã –º–∞—Å—Ç–µ—Ä–æ–≤
- `get_latest_reports()` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç—á–µ—Ç—ã

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ**:
- `approve_master()` - –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –º–∞—Å—Ç–µ—Ä–∞

### üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç
- **–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å Database –∫–ª–∞—Å—Å
- **40+ –º–µ—Ç–æ–¥–æ–≤** –¥–æ—Å—Ç—É–ø–Ω—ã –≤ ORMDatabase
- **–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ CRUD** –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- **Eager loading** –≤–µ–∑–¥–µ –≥–¥–µ –Ω—É–∂–Ω–æ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ N+1)
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤** —Å—Ç–∞—Ç—É—Å–æ–≤ —á–µ—Ä–µ–∑ State Machine
- **Soft delete** –¥–ª—è User –∏ Order

## –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

```bash
# –í .env —Ñ–∞–π–ª–µ
USE_ORM=false

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
python bot.py
```

–°—Ç–∞—Ä—ã–π –∫–æ–¥ —Å –ø—Ä—è–º—ã–º–∏ SQL –∑–∞–ø—Ä–æ—Å–∞–º–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

## –°—Å—ã–ª–∫–∏

- [SQLAlchemy 2.0 Documentation](https://docs.sqlalchemy.org/en/20/)
- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [asyncpg Documentation](https://magicstack.github.io/asyncpg/)
- [aiosqlite Documentation](https://aiosqlite.omnilib.dev/)

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**: 2025-10-20
**–ê–≤—Ç–æ—Ä**: AI Assistant
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
