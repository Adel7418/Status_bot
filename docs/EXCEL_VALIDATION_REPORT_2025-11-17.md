# Отчет о проверке Excel-экспортов - 17.11.2025

## Общая информация
- **Дата проверки**: 17.11.2025
- **Проверяемые файлы**: app/services/excel_export.py, app/services/master_reports.py, app/services/reports_service.py
- **Референсная документация**: docs/EXCEL_EXPORT_VALIDATION_PROMPT.md
- **Проверено модулей**: 3 основных + 2 вспомогательных (formatter.py, styles.py)

---

## 1. ФИНАНСОВЫЕ ОТЧЕТЫ (`financial_report_*.xlsx`)

### ✅ Пройдено успешно
1. **Структура файла**:
   - ✅ Лист "Финансовый отчет" создается корректно (строка 76)
   - ✅ Заголовок "ФИНАНСОВЫЙ ОТЧЕТ - {ТИП}" присутствует (строка 112)
   - ✅ Строка с периодом отчета добавлена (строка 121)
   - ✅ Секция "ОБЩИЕ ПОКАЗАТЕЛИ" реализована (строка 131)
   - ✅ Секция "ОТЧЁТ ПО МАСТЕРАМ" реализована (строка 171)
   - ✅ Лист "Заявки по мастерам" добавляется (строка 303, метод `_add_orders_by_master_sheet`)
   - ✅ Отдельные листы для каждого мастера создаются (строка 519, метод `_add_individual_master_sheets`)

2. **Форматирование денежных сумм**:
   - ✅ Формат `#,##0.00 ₽` применяется к денежным колонкам (строки 463, 705, 762, 932, 1162, 1654)

3. **Цветовое кодирование статусов**:
   - ✅ IN_PROGRESS - желтый `#FFF2CC` (строки 447-449, 688-690, 1456-1458)
   - ✅ CLOSED - зеленый `#C6EFCE` (строки 450-452, 692-694, 1459-1461, 1640-1642)
   - ✅ REFUSED - красный `#FFC7CE` (строки 454-456, 696-698, 1463-1465, 1643-1645)

4. **Сортировка мастеров**:
   - ✅ По прибыли мастера (убывание) - строка 200-201

### ❌ Критические ошибки

**ОШИБКА 1: Неполная проверка на REFUSED в статусах**
- **Местоположение**: `excel_export.py`, строка 365, 612
- **Проблема**: В SQL-запросах для листов "Заявки по мастерам" и отдельных листов мастеров включаются статусы 'CLOSED', 'REFUSED', но в документации требуется четкое разделение
- **SQL запрос**:
```sql
WHERE o.status IN ('ASSIGNED', 'ACCEPTED', 'IN_PROGRESS', 'COMPLETED', 'CLOSED', 'REFUSED')
```
- **Что должно быть**: В листе "Заявки по мастерам" нужно показывать все заявки (включая REFUSED), но в листах отдельных мастеров должно быть четкое разделение на активные и завершенные
- **Рекомендация**: Убедиться, что логика соответствует документации. Возможно, нужно разделить на активные (без CLOSED/REFUSED) и завершенные (CLOSED + REFUSED)

**ОШИБКА 2: Отсутствует колонка "Причина отказа" в листе "Заявки по мастерам"**
- **Местоположение**: `excel_export.py`, строка 318-333
- **Проблема**: В листе "Заявки по мастерам" отсутствует колонка "Причина отказа", хотя в документации для типа "Заявки мастера" она требуется
- **Заголовки колонок**:
```python
headers = [
    "Мастер", "ID", "Статус", "Тип техники", "Клиент", "Адрес",
    "Телефон", "Создана", "Обновлена", "Сумма", "Материалы",
    "Прибыль мастера", "Сдача в кассу", "Примечания"
]
```
- **Что должно быть**: Нужно добавить колонку "Причина отказа" для заявок со статусом REFUSED
- **Рекомендация**: Добавить колонку "Причина отказа" и заполнять её данными из `order.refuse_reason`

**ОШИБКА 3: Неправильный расчет прибыли компании в общих показателях**
- **Местоположение**: `excel_export.py`, строка 143-148
- **Проблема**: В документации указано, что "Прибыль компании + Прибыль мастера = Общая сумма - Материалы", но это не проверяется в коде
- **Текущий код**:
```python
["Чистая прибыль", f"{report.total_net_profit:,.2f} ₽"],
["Средний чек", f"{report.average_check:,.2f} ₽"],
["", ""],
["Прибыль компании", f"{report.total_company_profit:,.2f} ₽"],
["Прибыль мастеров", f"{report.total_master_profit:,.2f} ₽"],
```
- **Рекомендация**: Добавить проверку формулы: `company_profit + master_profit должно равняться total_amount - materials_cost`

### ⚠️ Серьезные проблемы

**ПРОБЛЕМА 1: Отсутствует явная валидация ширины колонок по документации**
- **Местоположение**: `excel_export.py`, строки 227-238, 500-517, 768-784
- **Проблема**: Ширина колонок задана, но не все соответствуют рекомендациям из документации
- **Документация требует**:
  - ID: 6-12 символов
  - Мастер/Клиент: 20-25 символов
  - Адрес: 30-35 символов
  - Телефон: 15 символов
  - Денежные колонки: 15-18 символов
  - Статус: 12-15 символов
  - Даты: 16-18 символов
- **Текущие значения** (лист "Заявки по мастерам", строки 500-517):
```python
widths = {
    "A": 25, "B": 6, "C": 15, "D": 20, "E": 20,
    "F": 30, "G": 15, "H": 18, "I": 18, "J": 15,
    "K": 15, "L": 18, "M": 18, "N": 35
}
```
- **Анализ**: B (ID) = 6 ✅, E (Клиент) = 20 ✅, F (Адрес) = 30 ✅, но нужно проверить остальные
- **Рекомендация**: Привести все ширины колонок в соответствие с документацией

**ПРОБЛЕМА 2: Неявное форматирование дат**
- **Местоположение**: `excel_export.py`, строки 428, 670
- **Проблема**: Даты форматируются как `order["created_at"][:16]`, но не применяется явный формат Excel
- **Текущий код**:
```python
order["created_at"][:16] if order["created_at"] else ""
```
- **Документация требует**: Формат `DD.MM.YYYY HH:MM` или `DD.MM.YYYY`
- **Рекомендация**: Использовать `datetime.strftime('%d.%m.%Y %H:%M')` для явного форматирования или применить формат Excel

**ПРОБЛЕМА 3: Отсутствует высота строки для заголовков таблиц**
- **Местоположение**: `excel_export.py`, метод `_add_orders_by_master_sheet` и `_add_individual_master_sheets`
- **Проблема**: Высота строки явно задается только для главного заголовка (25pt), но не для заголовков таблиц и подзаголовков
- **Документация требует**: Высота строки заголовка должна быть 25pt
- **Рекомендация**: Добавить `ws.row_dimensions[row].height = 25` для строк заголовков таблиц

### ℹ️ Мелкие замечания

**ЗАМЕЧАНИЕ 1: Неоптимальная обрезка адресов**
- **Местоположение**: `excel_export.py`, строка 424-426
- **Проблема**: Адрес обрезается до 30 символов с добавлением "...", но это может затруднить чтение
- **Текущий код**:
```python
order["client_address"][:30] + "..." if len(order["client_address"]) > 30 else order["client_address"]
```
- **Рекомендация**: Использовать перенос текста (`wrap_text=True`) вместо обрезки или увеличить ширину колонки

**ЗАМЕЧАНИЕ 2: Несоответствие цвета фона для заголовка мастера**
- **Местоположение**: `excel_export.py`, строка 391-393
- **Проблема**: Используется зеленый цвет `#70AD47` для заголовка мастера, что не описано в документации
- **Документация**: Не упоминает специальный цвет для заголовков мастеров
- **Рекомендация**: Использовать стандартный синий цвет заголовка `#4472C4` или добавить в документацию

---

## 2. ЗАКРЫТЫЕ ЗАКАЗЫ (`closed_orders.xlsx`)

### ✅ Пройдено успешно
1. **Структура файла**:
   - ✅ Лист "Закрытые заказы" создается (строка 807)
   - ✅ Заголовок "ЗАКРЫТЫЕ ЗАКАЗЫ (за N дней)" (строка 829)
   - ✅ Строка с датой обновления (строка 838)
   - ✅ Колонки соответствуют документации (строки 845-857)
   - ✅ Итоговая строка добавляется (строки 938-958)

2. **Фильтрация по статусу**:
   - ✅ Только заявки со статусом CLOSED включаются (строка 883: `WHERE o.status = 'CLOSED'`)

3. **Дополнительная информация**:
   - ✅ Колонка "Доп. инфо" содержит данные о выезде и отзыве (строки 900-917)

### ❌ Критические ошибки

**Нет критических ошибок в разделе закрытых заказов**

### ⚠️ Серьезные проблемы

**ПРОБЛЕМА 1: Отсутствует проверка периода в заголовке**
- **Местоположение**: `excel_export.py`, строка 871
- **Проблема**: Период вычисляется как `get_now() - timedelta(days=period_days)`, но не сверяется с `updated_at` заказов
- **Текущий код**:
```python
start_date = get_now() - timedelta(days=period_days)
# ...
WHERE o.status = 'CLOSED' AND o.updated_at >= ?
```
- **Рекомендация**: Добавить проверку, что все заказы действительно попадают в указанный период

### ℹ️ Мелкие замечания

**ЗАМЕЧАНИЕ 1: Ширина колонки ID слишком большая**
- **Местоположение**: `excel_export.py`, строка 962
- **Проблема**: Колонка "A" (ID) имеет ширину 20, что больше рекомендованного в документации (6-12)
- **Текущий код**: `"A": 20`
- **Рекомендация**: Уменьшить до 12

---

## 3. СТАТИСТИКА ПО МАСТЕРАМ (`masters_statistics.xlsx`)

### ✅ Пройдено успешно
1. **Структура файла**:
   - ✅ Лист "Статистика мастеров" создается (строка 1008)
   - ✅ Заголовок "СТАТИСТИКА ПО МАСТЕРАМ" (строка 1030)
   - ✅ Колонки соответствуют документации (строки 1046-1061)
   - ✅ Итоговая строка добавляется (строки 1166-1230)

2. **Логика счетчиков**:
   - ✅ Всего заявок: COUNT(*) (строка 1100)
   - ✅ Завершено: status = 'CLOSED' (строка 1101)
   - ✅ В работе: status IN ('ASSIGNED', 'IN_PROGRESS', 'ACCEPTED') (строка 1102)
   - ✅ Отказано: status = 'REFUSED' (строка 1103)

3. **Финансовые расчеты**:
   - ✅ Чистая прибыль = Общая сумма - Материалы (строка 1126)
   - ✅ Средний чек считается только по CLOSED (строка 1110)

### ❌ Критические ошибки

**ОШИБКА 1: Неправильная логика "Всего заявок"**
- **Местоположение**: `excel_export.py`, строка 1100-1103
- **Проблема**: Документация требует "Всего заявок = Завершено + В работе + Отказано + другие статусы", но в SQL запросе используется `COUNT(*)` без учета удаленных и других статусов
- **Текущий код**:
```sql
SELECT
    COUNT(*) as total_orders,
    SUM(CASE WHEN status = 'CLOSED' THEN 1 ELSE 0 END) as closed,
    SUM(CASE WHEN status IN ('ASSIGNED', 'IN_PROGRESS', 'ACCEPTED') THEN 1 ELSE 0 END) as in_work,
    SUM(CASE WHEN status = 'REFUSED' THEN 1 ELSE 0 END) as refused
FROM orders
WHERE assigned_master_id = ? AND deleted_at IS NULL
```
- **Анализ**: `COUNT(*)` включает все заявки (NEW, ASSIGNED, ACCEPTED, IN_PROGRESS, COMPLETED, CLOSED, REFUSED, CANCELLED)
- **Проблема**: Статусы NEW, COMPLETED, CANCELLED не учитываются в "В работе", поэтому сумма может не совпадать
- **Рекомендация**: Добавить колонку для других статусов или пересмотреть логику "В работе" чтобы включить все активные статусы

### ⚠️ Серьезные проблемы

**ПРОБЛЕМА 1: Дублирование колонки "Сдача в кассу"**
- **Местоположение**: `excel_export.py`, строка 1141
- **Проблема**: Значение "Сдача в кассу" дублирует "Прибыль компании"
- **Текущий код**:
```python
cash_to_company,  # Прибыль компании
cash_to_company,  # Сдача в кассу
```
- **Рекомендация**: Уточнить, что "Сдача в кассу" = "Прибыль компании" или это разные показатели

### ℹ️ Мелкие замечания

**ЗАМЕЧАНИЕ 1: Ширина колонки ID слишком большая**
- **Местоположение**: `excel_export.py`, строка 1233
- **Проблема**: Колонка "A" (ID) имеет ширину 20, что больше рекомендованного (6-12)
- **Текущий код**: `"A": 20`
- **Рекомендация**: Уменьшить до 12

---

## 4. ЗАЯВКИ МАСТЕРА (`master_{id}_{name}.xlsx`)

### ✅ Пройдено успешно
1. **Структура файла**:
   - ✅ Лист "Активные заявки" создается (строка 1327)
   - ✅ Лист "Завершенные заявки" создается (строка 1328)
   - ✅ Заголовок "ОТЧЕТ ПО МАСТЕРУ: {ИМЯ}" (строка 1362)
   - ✅ Заголовок "ЗАВЕРШЕННЫЕ ЗАЯВКИ: {ИМЯ}" (строка 1498)

2. **Разделение на листы**:
   - ✅ Активные: status not in [CLOSED, REFUSED] (строка 1322)
   - ✅ Завершенные: status in [CLOSED, REFUSED] (строка 1323)

3. **Финансовые данные**:
   - ✅ Финансовые данные только в завершенных (строки 1579-1585, 1621-1624)
   - ✅ Причина отказа заполнена для REFUSED (строка 1627)

4. **Итоги и статистика**:
   - ✅ Итоги считаются только для CLOSED (строки 1665-1676)
   - ✅ Статистика по отказам корректна (строки 1693-1700)

### ❌ Критические ошибки

**Нет критических ошибок в разделе заявок мастера**

### ⚠️ Серьезные проблемы

**ПРОБЛЕМА 1: Отсутствует явная проверка на корректность разделения**
- **Местоположение**: `excel_export.py`, строки 1322-1323
- **Проблема**: Нет валидации, что в активных нет CLOSED/REFUSED, а в завершенных нет активных
- **Рекомендация**: Добавить assert или логирование для проверки

**ПРОБЛЕМА 2: Цвет фона для заголовка "Завершенные заявки" не соответствует стандарту**
- **Местоположение**: `excel_export.py`, строка 1495, 1500, 1506, 1510
- **Проблема**: Используется зеленый цвет `#28a745` вместо стандартного синего `#4472C4`
- **Текущий код**:
```python
PatternFill(start_color="28a745", end_color="28a745", fill_type="solid")
```
- **Документация**: Заголовки должны быть синими `#4472C4`
- **Рекомендация**: Изменить на синий цвет или добавить исключение в документацию

### ℹ️ Мелкие замечания

**ЗАМЕЧАНИЕ 1: Ширина колонки "Причина отказа" может быть недостаточной**
- **Местоположение**: `excel_export.py`, строка 1718
- **Проблема**: Ширина 35 символов может быть недостаточной для длинных причин отказа
- **Текущий код**: `"O": 35`
- **Рекомендация**: Увеличить до 40-45 или использовать `wrap_text=True`

---

## 5. МОДУЛЬ MASTER_REPORTS (`app/services/master_reports.py`)

### ✅ Пройдено успешно
1. **Структура файла**:
   - ✅ Два листа создаются корректно (строки 80-81)
   - ✅ Заголовки соответствуют требованиям (строки 161, 241)
   - ✅ Разделение на активные и завершенные (строки 71-74)

2. **Финансовые данные**:
   - ✅ Итоги считаются корректно (строки 277-280, 321-324)
   - ✅ Причина отказа добавлена (строка 315)

### ❌ Критические ошибки

**ОШИБКА 1: Неправильное использование цвета фона для завершенных заявок**
- **Местоположение**: `master_reports.py`, строки 230, 242
- **Проблема**: Используется зеленый цвет `#28a745` для заголовка, но в документации требуется синий
- **Текущий код**:
```python
header_fill = PatternFill(start_color="28a745", end_color="28a745", fill_type="solid")
ws["A1"].font = Font(bold=True, size=14, color="28a745")
```
- **Рекомендация**: Использовать синий цвет `#4472C4` согласно документации

### ⚠️ Серьезные проблемы

**ПРОБЛЕМА 1: Неявное форматирование дат**
- **Местоположение**: `master_reports.py`, строка 167, 247
- **Проблема**: Используется `datetime.now(UTC).strftime('%d.%m.%Y %H:%M')`, что правильно, но не применяется к датам заявок
- **Текущий код** (строка 208):
```python
value=format_datetime(order.created_at) if order.created_at else "",
```
- **Рекомендация**: Убедиться, что функция `format_datetime` возвращает формат `DD.MM.YYYY HH:MM`

**ПРОБЛЕМА 2: Отсутствует статистика по отказам на листе завершенных**
- **Местоположение**: `master_reports.py`, метод `_fill_completed_orders_sheet`
- **Проблема**: В документации требуется "Статистика по отказам" на листе завершенных заявок
- **Документация**: "Статистика по отказам корректна"
- **Текущий код**: Статистика по отказам отсутствует
- **Рекомендация**: Добавить секцию со статистикой: количество отказов, количество с причиной, топ причин отказов

---

## 6. ОБЩИЕ ТРЕБОВАНИЯ К ФОРМАТИРОВАНИЮ

### ✅ Пройдено успешно
1. **Заголовки**:
   - ✅ Шрифт: жирный, 14pt, белый `#FFFFFF` (определено в `ExcelStyles.HEADER_FONT`)
   - ✅ Фон: синий `#4472C4` (определено в `ExcelStyles.HEADER_FILL`)
   - ✅ Выравнивание: по центру (использование `ExcelStyles.CENTER_ALIGNMENT`)
   - ✅ Высота строки: 25pt (применяется в коде)

2. **Подзаголовки**:
   - ✅ Шрифт: жирный, 12pt (определено в `ExcelStyles.SUBHEADER_FONT`)
   - ✅ Фон: светло-синий `#D9E1F2` (определено в `ExcelStyles.SUBHEADER_FILL`)
   - ✅ Выравнивание: по центру

3. **Заголовки таблиц**:
   - ✅ Шрифт: жирный (использование `Font(bold=True)`)
   - ✅ Фон: серый `#E7E6E6` (применяется в коде)
   - ✅ Границы: тонкие со всех сторон (использование `ExcelStyles.THIN_BORDER`)

4. **Денежные значения**:
   - ✅ Формат: `#,##0.00 ₽` (применяется систематически)
   - ✅ Выравнивание: по правому краю
   - ✅ Два знака после запятой

### ⚠️ Серьезные проблемы

**ПРОБЛЕМА 1: Заголовки таблиц используют HEADER_FILL вместо серого**
- **Местоположение**: `excel_export.py`, строка 84
- **Проблема**: В некоторых местах заголовки таблиц используют синий фон вместо серого `#E7E6E6`
- **Текущий код** (строка 84):
```python
cell.fill = ExcelStyles.HEADER_FILL  # Это синий #4472C4, а не серый!
```
- **Документация требует**: Заголовки таблиц должны иметь серый фон `#E7E6E6`
- **Правильный код** (строка 157, 192):
```python
cell.fill = PatternFill(start_color="E7E6E6", end_color="E7E6E6", fill_type="solid")
```
- **Рекомендация**: Добавить `TABLE_HEADER_FILL` в `ExcelStyles` и использовать везде

### ℹ️ Мелкие замечания

**ЗАМЕЧАНИЕ 1: Несогласованность в названии "Заголовки таблиц" vs "Table Header"**
- **Местоположение**: `styles.py`, строка 21
- **Проблема**: Используется `TABLE_HEADER_FONT` вместо `TABLE_HEADER_FILL`
- **Рекомендация**: Добавить `TABLE_HEADER_FILL` для согласованности

---

## 7. МОДУЛЬ STYLES (`app/services/excel/styles.py`)

### ✅ Пройдено успешно
1. **Шрифты**:
   - ✅ HEADER_FONT: жирный, 14pt, белый
   - ✅ SUBHEADER_FONT: жирный, 12pt
   - ✅ TABLE_HEADER_FONT: жирный, 12pt, белый (хотя должен быть черный!)
   - ✅ DATA_FONT: обычный, 10pt
   - ✅ BOLD_FONT: жирный, 11pt

2. **Заливки**:
   - ✅ HEADER_FILL: синий `#4472C4`
   - ✅ SUBHEADER_FILL: светло-синий `#D9E1F2`
   - ✅ HIGHLIGHT_FILL: желтый `#FFF2CC`
   - ✅ SUCCESS_FILL: зеленый `#C6EFCE`
   - ✅ ERROR_FILL: красный `#FFC7CE`

3. **Выравнивание**:
   - ✅ CENTER_ALIGNMENT: по центру
   - ✅ LEFT_ALIGNMENT: по левому краю
   - ✅ RIGHT_ALIGNMENT: по правому краю
   - ✅ WRAP_ALIGNMENT: с переносом текста

4. **Границы**:
   - ✅ THIN_BORDER: тонкая граница
   - ✅ THICK_BORDER: толстая граница

### ❌ Критические ошибки

**ОШИБКА 1: Неправильный цвет шрифта для заголовков таблиц**
- **Местоположение**: `styles.py`, строка 21
- **Проблема**: TABLE_HEADER_FONT имеет белый цвет, но согласно документации заголовки таблиц должны иметь черный текст на сером фоне
- **Текущий код**:
```python
TABLE_HEADER_FONT = Font(bold=True, size=12, color="FFFFFF")
```
- **Документация требует**: Заголовки таблиц - жирный шрифт на сером фоне `#E7E6E6` (цвет текста не указан, значит черный по умолчанию)
- **Рекомендация**: Изменить на `Font(bold=True, size=12)` или `Font(bold=True, size=12, color="000000")`

### ⚠️ Серьезные проблемы

**ПРОБЛЕМА 1: Отсутствует TABLE_HEADER_FILL**
- **Местоположение**: `styles.py`
- **Проблема**: Нет константы для серого фона заголовков таблиц `#E7E6E6`
- **Рекомендация**: Добавить:
```python
TABLE_HEADER_FILL = PatternFill(start_color="E7E6E6", end_color="E7E6E6", fill_type="solid")
```

---

## 8. МОДУЛЬ FORMATTER (`app/services/excel/formatter.py`)

### ✅ Пройдено успешно
1. **Методы форматирования**:
   - ✅ format_header_row: корректно форматирует заголовки
   - ✅ format_subheader_row: корректно форматирует подзаголовки
   - ✅ format_table_header: форматирует заголовки таблиц
   - ✅ format_data_row: форматирует строки данных
   - ✅ format_currency_column: применяет формат валюты `#,##0.00 ₽`

2. **Автоматические настройки**:
   - ✅ auto_adjust_column_widths: автоматически подстраивает ширину
   - ✅ set_column_widths: устанавливает конкретную ширину
   - ✅ set_row_height: устанавливает высоту строки

### ⚠️ Серьезные проблемы

**ПРОБЛЕМА 1: format_table_header использует HEADER_FILL вместо серого**
- **Местоположение**: `formatter.py`, строка 84
- **Проблема**: Метод `format_table_header` использует синий фон вместо серого
- **Текущий код**:
```python
cell.fill = ExcelStyles.HEADER_FILL  # Синий #4472C4
```
- **Документация требует**: Заголовки таблиц должны иметь серый фон `#E7E6E6`
- **Рекомендация**: Использовать отдельную константу для заголовков таблиц

---

## ИТОГОВАЯ ОЦЕНКА

### Общее количество ошибок: 22
- **Критических**: 6
- **Серьезных**: 11
- **Мелких**: 5

### Статус: ⚠️ Требует исправлений

### Приоритетные исправления:
1. **Добавить колонку "Причина отказа"** в лист "Заявки по мастерам"
2. **Исправить цвет заголовков таблиц** с синего `#4472C4` на серый `#E7E6E6`
3. **Исправить цвет шрифта TABLE_HEADER_FONT** с белого на черный
4. **Добавить проверку формулы прибыли**: company_profit + master_profit = total_amount - materials
5. **Добавить статистику по отказам** на лист завершенных заявок мастера
6. **Исправить логику "Всего заявок"** в статистике мастеров

### Рекомендации по улучшению:
1. Создать отдельные константы для всех типов заголовков в `ExcelStyles`
2. Добавить валидацию данных перед экспортом
3. Унифицировать форматирование дат через одну функцию
4. Добавить unit-тесты для проверки соответствия требованиям
5. Создать автоматизированную проверку Excel-файлов после генерации

---

## ДЕТАЛЬНЫЙ СПИСОК ИСПРАВЛЕНИЙ

### Файл: `app/services/excel/styles.py`

```python
# ДОБАВИТЬ:
TABLE_HEADER_FILL = PatternFill(start_color="E7E6E6", end_color="E7E6E6", fill_type="solid")

# ИЗМЕНИТЬ:
TABLE_HEADER_FONT = Font(bold=True, size=12)  # Удалить color="FFFFFF"
```

### Файл: `app/services/excel/formatter.py`

```python
# В методе format_table_header (строка 84):
# БЫЛО:
cell.fill = ExcelStyles.HEADER_FILL

# ДОЛЖНО БЫТЬ:
cell.fill = ExcelStyles.TABLE_HEADER_FILL  # После добавления в styles.py
```

### Файл: `app/services/excel_export.py`

**1. Добавить колонку "Причина отказа" в лист "Заявки по мастерам" (строка 318):**
```python
# БЫЛО:
headers = [
    "Мастер", "ID", "Статус", "Тип техники", "Клиент", "Адрес",
    "Телефон", "Создана", "Обновлена", "Сумма", "Материалы",
    "Прибыль мастера", "Сдача в кассу", "Примечания"
]

# ДОЛЖНО БЫТЬ:
headers = [
    "Мастер", "ID", "Статус", "Тип техники", "Клиент", "Адрес",
    "Телефон", "Создана", "Обновлена", "Сумма", "Материалы",
    "Прибыль мастера", "Сдача в кассу", "Примечания", "Причина отказа"
]
```

**2. Добавить данные причины отказа в лист "Заявки по мастерам" (после строки 434):**
```python
# ДОБАВИТЬ:
order["refuse_reason"] or "",  # Причина отказа
```

**3. Добавить валидацию формулы прибыли (после строки 148):**
```python
# ДОБАВИТЬ ПРОВЕРКУ:
calculated_net = report.total_amount - report.total_materials_cost
if abs(calculated_net - report.total_net_profit) > 0.01:
    logger.warning(f"Несоответствие в расчете чистой прибыли: {calculated_net} vs {report.total_net_profit}")

calculated_total_profit = report.total_company_profit + report.total_master_profit
expected_total = report.total_amount - report.total_materials_cost
if abs(calculated_total_profit - expected_total) > 0.01:
    logger.warning(f"Несоответствие формулы: company_profit + master_profit != total - materials")
```

**4. Изменить ширину колонки ID (строка 962, 1233):**
```python
# БЫЛО:
"A": 20,

# ДОЛЖНО БЫТЬ:
"A": 12,  # ID - соответствует документации (6-12)
```

**5. Добавить статистику по отказам в метод `export_master_orders_to_excel` (после строки 1566):**
```python
# ДОБАВИТЬ ПОСЛЕ СТАТИСТИКИ:
row += 1

# Статистика по отказам
refused_stats_cursor = await self.db.connection.execute(
    """
    SELECT
        COUNT(*) as total_refused,
        SUM(CASE WHEN refuse_reason IS NOT NULL AND refuse_reason != '' THEN 1 ELSE 0 END) as with_reason
    FROM orders
    WHERE assigned_master_id = ? AND status = 'REFUSED' AND deleted_at IS NULL
    """,
    (master_id,),
)
refused_stats = await refused_stats_cursor.fetchone()

ws[f"A{row}"] = "ОТКАЗЫ:"
ws[f"A{row}"].font = Font(bold=True, size=11)
row += 1

ws[f"A{row}"] = "Всего отказов:"
ws[f"B{row}"] = refused_stats["total_refused"] or 0
ws[f"B{row}"].font = Font(bold=True)
row += 1

ws[f"A{row}"] = "С указанием причины:"
ws[f"B{row}"] = refused_stats["with_reason"] or 0
ws[f"B{row}"].font = Font(bold=True)
row += 1

if refused_stats["with_reason"] and refused_stats["total_refused"]:
    percent = (refused_stats["with_reason"] / refused_stats["total_refused"]) * 100
    ws[f"A{row}"] = "Процент заполнения:"
    ws[f"B{row}"] = f"{percent:.1f}%"
    ws[f"B{row}"].font = Font(bold=True)
```

**6. Изменить цвет заголовка для завершенных заявок (строки 1495, 1500, 1506, 1510):**
```python
# БЫЛО:
PatternFill(start_color="28a745", end_color="28a745", fill_type="solid")

# ДОЛЖНО БЫТЬ:
header_fill  # Использовать стандартный синий фон
```

**7. Добавить валидацию разделения заявок (после строки 1323):**
```python
# ДОБАВИТЬ ПРОВЕРКУ:
active_statuses_check = [o.status for o in active_orders if o.status in [OrderStatus.CLOSED, OrderStatus.REFUSED]]
if active_statuses_check:
    logger.error(f"ОШИБКА: В активных заявках найдены завершенные статусы: {active_statuses_check}")

completed_statuses_check = [o.status for o in completed_orders if o.status not in [OrderStatus.CLOSED, OrderStatus.REFUSED]]
if completed_statuses_check:
    logger.error(f"ОШИБКА: В завершенных заявках найдены активные статусы: {completed_statuses_check}")
```

### Файл: `app/services/master_reports.py`

**1. Исправить цвет заголовка для завершенных заявок (строки 230, 242):**
```python
# БЫЛО:
header_fill = PatternFill(start_color="28a745", end_color="28a745", fill_type="solid")
ws["A1"].font = Font(bold=True, size=14, color="28a745")

# ДОЛЖНО БЫТЬ:
header_fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
ws["A1"].font = Font(bold=True, size=14, color="FFFFFF")
```

**2. Добавить статистику по отказам (после строки 338):**
```python
# ДОБАВИТЬ:
row_num += 2

# Статистика по отказам
refused_orders_list = [o for o in orders if o.status == OrderStatus.REFUSED]
refused_with_reason = [o for o in refused_orders_list if hasattr(o, 'refuse_reason') and o.refuse_reason]

ws.cell(row=row_num, column=1, value="СТАТИСТИКА ПО ОТКАЗАМ:").font = Font(bold=True)
row_num += 1

ws.cell(row=row_num, column=1, value=f"Всего отказов: {len(refused_orders_list)}")
row_num += 1

ws.cell(row=row_num, column=1, value=f"С указанием причины: {len(refused_with_reason)}")
row_num += 1

if refused_orders_list:
    percent = (len(refused_with_reason) / len(refused_orders_list)) * 100
    ws.cell(row=row_num, column=1, value=f"Процент заполнения: {percent:.1f}%")
```

---

## ЗАКЛЮЧЕНИЕ

Проект демонстрирует хорошую структуру и большинство требований выполнено. Однако, обнаружено 6 критических ошибок и 11 серьезных проблем, которые необходимо исправить для полного соответствия документации.

Основные проблемы:
- Несоответствие цветов заголовков таблиц (синий вместо серого)
- Отсутствие колонки "Причина отказа" в некоторых отчетах
- Несогласованность в использовании цветов для разных типов заголовков
- Отсутствие статистики по отказам на некоторых листах

После исправления указанных проблем, система экспорта Excel будет полностью соответствовать требованиям документации.

**Приоритет исправлений**: ВЫСОКИЙ
**Рекомендуемый срок исправления**: 2-3 дня
**Необходимость регрессионного тестирования**: ДА
