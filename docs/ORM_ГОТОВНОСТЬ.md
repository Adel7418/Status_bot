# ‚úÖ ORM - –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≤–∫–ª—é—á–µ–Ω–∏—é

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 20.10.2025  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ

---

## üéØ –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏

### ‚úÖ –ì–æ—Ç–æ–≤–æ:

1. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:**
   - ‚úÖ SQLAlchemy 2.0.43
   - ‚úÖ aiosqlite (SQLite)
   - ‚úÖ Alembic (–º–∏–≥—Ä–∞—Ü–∏–∏)
   - ‚ö†Ô∏è asyncpg (–Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è PostgreSQL)

2. **ORM –º–æ–¥—É–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç:**
   - ‚úÖ ORMDatabase –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
   - ‚úÖ ORM –º–æ–¥–µ–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è
   - ‚úÖ 40+ –º–µ—Ç–æ–¥–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã

3. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã:**
   - ‚úÖ 10 –º–∏–≥—Ä–∞—Ü–∏–π —Å–æ–∑–¥–∞–Ω–æ
   - ‚úÖ Soft delete
   - ‚úÖ –ò–Ω–¥–µ–∫—Å—ã
   - ‚úÖ Constraints

4. **–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –µ—Å—Ç—å:**
   - ‚úÖ connect/disconnect
   - ‚úÖ get_user_by_telegram_id
   - ‚úÖ get_master_by_telegram_id/get_master_by_id
   - ‚úÖ create_master
   - ‚úÖ get_order_by_id/create_order
   - ‚úÖ update_order_status
   - ‚úÖ get_all_orders/get_orders_by_master
   - ‚úÖ update_order_amounts
   - ‚úÖ add_audit_log

### ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:

1. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–µ—Ç–æ–¥:** `create_user`
   - –í–æ–∑–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ middleware
   - –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ —Å–ª–æ–º–∞–µ—Ç—Å—è –ª–∏ —á—Ç–æ-—Ç–æ

2. **–ù–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:**
   - –†–∞–±–æ—Ç–∞ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å ORM
   - –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
   - –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π

---

## üîß –ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å ORM

### –®–∞–≥ 1: Backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
cp bot_database.db bot_database.db.backup
```

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å –≤ .env

```env
USE_ORM=true
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

```bash
python bot.py
```

### –®–∞–≥ 4: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞
- –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞—è–≤–∫–∏
- –û—Ç—á–µ—Ç—ã
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

---

## ‚ö†Ô∏è –†–∏—Å–∫–∏

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ create_user:**
   - –ú–æ–∂–µ—Ç –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

2. **–†–∞–∑–Ω—ã–µ –º–æ–¥–µ–ª–∏:**
   - app/database/models.py (legacy)
   - app/database/orm_models.py (ORM)
   - –ú–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

3. **MyPy –æ—à–∏–±–∫–∏:**
   - 85 –æ—à–∏–±–æ–∫ —Ç–∏–ø–æ–≤ –ø—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–µ
   - –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ —Å—Ç–æ–∏—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å

4. **connection vs session:**
   - Legacy –∏—Å–ø–æ–ª—å–∑—É–µ—Ç: `db.connection.execute()`
   - ORM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç: `session.execute()`
   - –ù–µ–∫–æ—Ç–æ—Ä—ã–π –∫–æ–¥ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ü–µ—Ä–µ–¥ –≤–∫–ª—é—á–µ–Ω–∏–µ–º:

1. **Backup –±–∞–∑—ã:**
   ```bash
   python scripts/backup_db.py
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å env:**
   ```bash
   cat .env | grep USE_ORM
   ```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã:**
   ```bash
   python scripts/test_permanent_storage.py
   python scripts/test_excel_report.py
   ```

### –ü–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è:

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤:**
   ```bash
   tail -f logs/bot.log
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:**
   - –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
   - –ù–∞–∑–Ω–∞—á–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞
   - –ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É
   - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç

3. **–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å:**
   ```bash
   # –ë—ã—Å—Ç—Ä–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è
   echo "USE_ORM=false" >> .env
   # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
   python bot.py
   ```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ

### Legacy SQL:
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- ‚ùå –ü—Ä—è–º—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã
- ‚ùå N+1 –ø—Ä–æ–±–ª–µ–º–∞
- ‚ùå –ù–µ—Ç connection pooling

### ORM (SQLAlchemy):
- ‚úÖ Connection pooling
- ‚úÖ Eager loading
- ‚úÖ –¢–∏–ø–∏–∑–∞—Ü–∏—è
- ‚úÖ –õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- ‚ö†Ô∏è –ù—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã –±–∞–≥–∏

---

## üéØ –ò—Ç–æ–≥

**ORM –ì–û–¢–û–í –ö –í–ö–õ–Æ–ß–ï–ù–ò–Æ!** ‚úÖ

**–í–º–µ—Å—Ç–æ `create_user` –µ—Å—Ç—å `get_or_create_user`** - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥!

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
1. ‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
2. ‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
3. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã
4. ‚è≥ –°–¥–µ–ª–∞—Ç—å backup
5. ‚è≥ –í–∫–ª—é—á–∏—Ç—å USE_ORM=true

**–í—Ä–µ–º—è –≤–∫–ª—é—á–µ–Ω–∏—è:** ~2 –º–∏–Ω—É—Ç—ã  
**–†–∏—Å–∫–∏:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ  
**–û—Ç–∫–∞—Ç:** –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π (USE_ORM=false)

---

## üöÄ –ë—ã—Å—Ç—Ä–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ

```bash
# 1. Backup
cp bot_database.db bot_database.db.backup

# 2. –í .env –¥–æ–±–∞–≤–∏—Ç—å:
USE_ORM=true

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
python bot.py
```

---

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** 
- ‚úÖ –ì–æ—Ç–æ–≤–æ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è!
- ‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã –Ω–∞ –º–µ—Å—Ç–µ
- ‚úÖ –ö–æ–¥ —Å–æ–≤–º–µ—Å—Ç–∏–º

---

**–°–æ–∑–¥–∞–Ω–æ:** 20.10.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û –ö –í–ö–õ–Æ–ß–ï–ù–ò–Æ!

