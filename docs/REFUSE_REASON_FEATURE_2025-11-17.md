# Добавление функционала причин отказа от заявок

**Дата:** 17 ноября 2025

## Описание изменений

Реализован функционал для отслеживания причин отказа от заявок с дополнительной логикой автоматического определения отказов при малых суммах.

## Основные изменения

### 1. Модель данных

#### `app/database/orm_models.py`
- Поле `refuse_reason` уже существовало в модели `Order` (строка 214)
- Тип: `Mapped[str | None] = mapped_column(String(500), nullable=True)`

#### `app/database/orm_database.py`
- Обновлен метод `unassign_master_from_order()` для поддержки параметра `refuse_reason`
- Метод теперь сохраняет причину отказа при снятии мастера с заявки

### 2. FSM состояния (`app/states.py`)

Добавлены новые состояния:

#### `RefuseOrderStates`:
- `enter_refuse_reason` - ввод причины отказа при отклонении заявки

#### `CompleteOrderStates`:
- `confirm_low_amount_refusal` - подтверждение отказа для сумм <1000р
- `enter_refuse_reason_on_complete` - ввод причины отказа при завершении с малой суммой

### 3. Логика обработки отказов (`app/handlers/master.py`)

#### Изменения в функции `callback_refuse_order_master`:
- Теперь не выполняет отказ сразу
- Запрашивает причину отказа/отмены
- Динамический текст: "отмена" для NEW/ACCEPTED, "отказ" для других статусов

#### Новый обработчик `process_refuse_reason`:
- Принимает ввод причины отказа
- Валидирует (минимум 3 символа)
- Сохраняет причину в БД через `unassign_master_from_order()`
- Уведомляет диспетчера с указанием причины

#### Проверка суммы <1000р в `process_total_amount`:
```python
if total_amount < 1000:
    # Спрашиваем "Это отказ?"
    # Показываем кнопки: "Да, это отказ" / "Нет, продолжить"
```

#### Новый обработчик `callback_low_amount_refusal_confirmation`:
- Обрабатывает ответ на вопрос "Это отказ?"
- Если "Да" → запрашивает причину отказа
- Если "Нет" → продолжает обычное завершение

#### Обновлена функция `complete_order_as_refusal`:
- Добавлен параметр `refuse_reason`
- Сохраняет причину отказа в БД
- Логирует причину в audit_log

### 4. Клавиатура (`app/keyboards/inline.py`)

#### Динамический текст кнопок:
- **NEW/ACCEPTED**: "❌ Отмена"
- **ONSITE/другие**: "❌ Отказ"

#### Изменения для администраторов/диспетчеров (строки 203-214):
```python
refuse_button_text = (
    "❌ Отмена"
    if order.status in [OrderStatus.NEW, OrderStatus.ACCEPTED]
    else "❌ Отказ"
)
```

#### Изменения для мастеров:
- ASSIGNED: "❌ Отмена"
- ACCEPTED: добавлена кнопка "❌ Отмена" (строки 241-244)
- ONSITE: "❌ Отказ" (без изменений)

#### Групповые кнопки (строка 34):
- ASSIGNED: "❌ Отмена"

### 5. Статистика мастеров

#### `app/services/reports_service.py`
Добавлена колонка `refused_orders` в метод `_get_masters_stats`:
```python
refused_orders = len([o for o in orders if o.status == OrderStatus.REFUSED])
```

#### `app/handlers/admin.py`
Обновлен `callback_master_stats` для отображения причин отказов:
- Показывает первые 5 отказов с причинами
- Укорачивает длинные причины до 50 символов
- Показывает счетчик дополнительных отказов

### 6. Excel Export (`app/services/excel_export.py`)

#### Обновлен лист "Статистика мастеров":
- Добавлена колонка "Отказов с причиной" (колонка O)
- Подсчитывается количество отказов, где указана причина

#### Новый метод `_add_refusals_details_sheet`:
- Создает отдельный лист "Причины отказов"
- Колонки: ID заявки, Мастер, Клиент, Адрес, Дата отказа, Причина отказа
- Показывает только отказы с указанными причинами
- Сортировка по мастерам

## Сценарии использования

### Сценарий 1: Отклонение заявки мастером (личный чат)

1. Мастер видит заявку в статусе ASSIGNED
2. Нажимает кнопку "❌ Отмена"
3. Вводит причину отказа (например: "Слишком далеко")
4. Заявка возвращается в статус NEW
5. Диспетчер получает уведомление с причиной

### Сценарий 2: Отклонение заявки в групповом чате

1. Мастер в рабочей группе видит заявку
2. Нажимает кнопку "❌ Отмена"
3. Получает сообщение в личку с запросом причины
4. Вводит причину отказа
5. Сообщение в группе обновляется с указанием причины
6. Диспетчер получает уведомление

### Сценарий 3: Отклонение заявки админом/диспетчером

1. Админ открывает заявку в админ-панели
2. Нажимает кнопку "❌ Отмена" или "❌ Отказ"
3. Вводит причину отказа (например: "Дубликат заявки")
4. Заявка закрывается со статусом REFUSED
5. Мастер (если был назначен) получает уведомление с причиной

### Сценарий 4: Завершение с малой суммой

1. Мастер завершает заявку, вводит сумму 800₽
2. Бот спрашивает: "Это отказ?"
3. Если "Да":
   - Запрашивается причина отказа
   - Заявка закрывается со статусом REFUSED
   - Сохраняется причина
4. Если "Нет":
   - Продолжается обычное завершение
   - Запрашиваются материалы, отзыв и т.д.

### Сценарий 5: Просмотр статистики админом

1. Админ открывает статистику мастера
2. Видит общее количество отказов
3. Видит список первых 5 отказов с причинами
4. При экспорте в Excel получает детальный отчет

## Важные замечания

1. **Причина отказа обязательна**: минимум 3 символа
2. **Сохраняется в БД**: поле `refuse_reason` в таблице `orders`
3. **Логируется**: все отказы с причинами записываются в `audit_log`
4. **Уведомления**: диспетчер всегда получает уведомление с причиной

## Файлы, затронутые изменениями

1. `app/states.py` - FSM состояния
2. `app/handlers/master.py` - логика обработки отказов
3. `app/keyboards/inline.py` - динамические кнопки
4. `app/database/orm_database.py` - сохранение причины отказа
5. `app/services/reports_service.py` - статистика отказов
6. `app/services/excel_export.py` - Excel-отчеты с причинами
7. `app/handlers/admin.py` - отображение причин в статистике

## Тестирование

### Необходимо протестировать:

1. ✅ Отклонение заявки мастером (ASSIGNED → NEW)
2. ✅ Отмена заявки мастером (ACCEPTED → NEW)
3. ✅ Завершение с суммой <1000р → отказ
4. ✅ Завершение с суммой <1000р → продолжить
5. ✅ Просмотр статистики мастера с причинами отказов
6. ✅ Экспорт статистики в Excel
7. ✅ Уведомления диспетчера с причиной отказа

### Проверка данных:

- [ ] Причина отказа сохраняется в БД
- [ ] Причина отображается в статистике
- [ ] Причина попадает в Excel-отчет
- [ ] Уведомления содержат корректную причину

## Дополнительно

### Дополнительные реализованные сценарии:

1. ✅ **Запрос причины отказа в групповых чатах** - мастер получает запрос в личку
2. ✅ **Запрос причины для админов/диспетчеров** - при отклонении заявки в админ-панели

### Не реализовано (может быть добавлено позже):

1. Список типовых причин (вместо свободного ввода)
2. Аналитика по причинам отказов (топ-причин)
3. Фильтрация статистики по причинам отказов

### Известные ограничения:

1. Максимальная длина причины: 500 символов (ограничение БД)
2. В Excel-отчете показываются только отказы с причинами
3. В групповом чате запрос причины приходит в личку мастеру

## Автор

Claude (AI Assistant)
Дата: 17 ноября 2025
