# –≠–¢–ê–ü 4: OrderParserService (–ó–ê–í–ï–†–®–Å–ù)

**–î–∞—Ç–∞:** 27 —è–Ω–≤–∞—Ä—è 2025
**–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ~40 –º–∏–Ω—É—Ç
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–Å–ù

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª parser_service.py

**–§–∞–π–ª:** `app/services/telegram_parser/parser_service.py`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–µ—Ñ–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏.

### 2. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–ª–∞—Å—Å OrderParserService

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –°–µ—Ä–≤–∏—Å–Ω—ã–π –∫–ª–∞—Å—Å —Å –æ—Å–Ω–æ–≤–Ω—ã–º –º–µ—Ç–æ–¥–æ–º `parse_message()` –∏ –Ω–∞–±–æ—Ä–æ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤.

#### –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥: parse_message()

**–°–∏–≥–Ω–∞—Ç—É—Ä–∞:**

```python
def parse_message(self, text: str, message_id: int) -> ParseResult:
    """
    –ü–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∑–∞—è–≤–∫—É.

    Args:
        text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram
        message_id: ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram

    Returns:
        ParseResult —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –ø–∞—Ä—Å–∏–Ω–≥–∞ (success/failure)
    """
```

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø–∞—Ä—Å–∏–Ω–≥–∞ (7 —à–∞–≥–æ–≤):**

**–®–∞–≥ 1: –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞**
- –†–∞–∑–±–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ `_split_into_lines()`
- –£–¥–∞–ª—è–µ—Ç –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —Ç–µ–∫—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π

**–®–∞–≥ 2: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞**
- –í—ã–∑—ã–≤–∞–µ—Ç `_extract_phone_from_lines()`
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω —á–µ—Ä–µ–∑ `normalize_phone()` (—Ñ–æ—Ä–º–∞—Ç `+7XXXXXXXXXX`)
- –£–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –∏–∑ –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–®–∞–≥ 3: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏**
- –í—ã–∑—ã–≤–∞–µ—Ç `_extract_time_from_lines()`
- –ù–∞—Ö–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫–∏ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏
- –£–¥–∞–ª—è–µ—Ç –∏—Ö –∏–∑ –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–®–∞–≥ 4: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ/–ø—Ä–æ–±–ª–µ–º–∞ –∏ –∞–¥—Ä–µ—Å**
- –í—ã–∑—ã–≤–∞–µ—Ç `_split_equipment_and_address()`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–≤—Ä–∏—Å—Ç–∏–∫—É `looks_like_address()` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞
- –û—Å—Ç–∞–ª—å–Ω–æ–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã

**–®–∞–≥ 5: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è**
- –í—ã–∑—ã–≤–∞–µ—Ç `_extract_equipment_type()`
- –ë–µ—Ä—ë—Ç –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ (–¥–æ —Ç–æ—á–∫–∏/–∑–∞–ø—è—Ç–æ–π)
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —á–µ—Ä–µ–∑ `normalize_equipment_type()`

**–®–∞–≥ 6: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã**
- –í—ã–∑—ã–≤–∞–µ—Ç `_extract_problem_description()`
- –ë–µ—Ä—ë—Ç –æ—Å—Ç–∞—Ç–æ–∫ —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å–ª–µ —Ç–∏–ø–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ (—Ç–æ—á–∫–∞, –∑–∞–ø—è—Ç–∞—è)

**–®–∞–≥ 7: –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Pydantic**
- –°–æ–∑–¥–∞—ë—Ç –æ–±—ä–µ–∫—Ç `OrderParsed`
- Pydantic –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—Å–µ –ø–æ–ª—è
- –ü—Ä–∏ —É—Å–ø–µ—Ö–µ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `ParseResult(success=True)`
- –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `ParseResult(success=False)` —Å –¥–µ—Ç–∞–ª—è–º–∏

### 3. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã

#### _split_into_lines()

```python
def _split_into_lines(self, text: str) -> list[str]:
    """–†–∞–∑–±–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –∏ –æ—á–∏—â–∞–µ—Ç –∏—Ö."""
```

- –†–∞–∑–±–∏–≤–∞–µ—Ç –ø–æ `\n`
- –£–¥–∞–ª—è–µ—Ç –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç `.strip()` –∫ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ

#### _extract_phone_from_lines()

```python
def _extract_phone_from_lines(self, lines: list[str]) -> str | None:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–æ–∫."""
```

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ `extract_phone()`
- –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –ø—Ä–æ–±—É–µ—Ç –≤–µ—Å—å —Ç–µ–∫—Å—Ç —Ü–µ–ª–∏–∫–æ–º
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ `None`

#### _extract_time_from_lines()

```python
def _extract_time_from_lines(self, lines: list[str]) -> str | None:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–æ–∫."""
```

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ `contains_time_indicator()`
- –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏
- –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`

#### _split_equipment_and_address()

```python
def _split_equipment_and_address(self, lines: list[str]) -> tuple[str, str]:
    """–†–∞–∑–¥–µ–ª—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ/–ø—Ä–æ–±–ª–µ–º–∞ –∏ –∞–¥—Ä–µ—Å."""
```

**–≠–≤—Ä–∏—Å—Ç–∏–∫–∞:**
- –°—Ç—Ä–æ–∫–∏, –ø–æ—Ö–æ–∂–∏–µ –Ω–∞ –∞–¥—Ä–µ—Å (`looks_like_address()`) ‚Üí –∞–¥—Ä–µ—Å
- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ ‚Üí –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–±–ª–µ–º–∞
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ `(equipment_problem, address)`

#### _extract_equipment_type()

```python
def _extract_equipment_type(self, equipment_problem: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
```

- –ë–µ—Ä—ë—Ç –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å (–¥–æ —Ç–æ—á–∫–∏ –∏–ª–∏ –∑–∞–ø—è—Ç–æ–π)
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —á–µ—Ä–µ–∑ `normalize_equipment_type()`
- –ü—Ä–∏–º–µ—Ä—ã:
  - `"–°/–º –Ω–µ –∫—Ä—É—Ç–∏—Ç"` ‚Üí `"–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞"`
  - `"—Ç–≤ samsung –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è"` ‚Üí `"–¢–µ–ª–µ–≤–∏–∑–æ—Ä"`

#### _extract_problem_description()

```python
def _extract_problem_description(self, equipment_problem: str, equipment_type: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞."""
```

**–õ–æ–≥–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:**
1. –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ—á–∫–∞ ‚Äî –±–µ—Ä—ë—Ç –≤—Å—ë –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏
2. –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—è—Ç–∞—è ‚Äî –±–µ—Ä—ë—Ç –≤—Å—ë –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∑–∞–ø—è—Ç–æ–π
3. –ï—Å–ª–∏ –Ω–µ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø–µ—Ä–≤—ã–µ 1-2 —Å–ª–æ–≤–∞
4. Fallback: –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç

#### _create_error_result()

```python
def _create_error_result(
    self,
    error_message: str,
    status: str,
    missing_fields: list[str],
) -> ParseResult:
    """–°–æ–∑–¥–∞—ë—Ç ParseResult —Å –æ—à–∏–±–∫–æ–π."""
```

- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—à–∏–±–æ—á–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `success=False`, `data=None`
- –ó–∞–ø–æ–ª–Ω—è–µ—Ç `error_message` –∏ `missing_fields`

## –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞

### –ü—Ä–∏–º–µ—Ä 1: –£—Å–ø–µ—à–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ (–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

**–í—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:**
```
–°/–º –Ω–µ –∫—Ä—É—Ç–∏—Ç –±–∞—Ä–∞–±–∞–Ω, —à—É–º–∏—Ç –ø—Ä–∏ –æ—Ç–∂–∏–º–µ.
—É–ª. –õ–µ–Ω–∏–Ω–∞ 5, –∫–≤. 10
+79001234567
–∑–∞–≤—Ç—Ä–∞ –∫ 14:00
```

**–ü—Ä–æ—Ü–µ—Å—Å –ø–∞—Ä—Å–∏–Ω–≥–∞:**
1. –†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∫–∏ ‚Üí 4 —Å—Ç—Ä–æ–∫–∏
2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Üí `"+79001234567"`, —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ ‚Üí `"–∑–∞–≤—Ç—Ä–∞ –∫ 14:00"`, —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
4. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ:
   - –ê–¥—Ä–µ—Å: `"—É–ª. –õ–µ–Ω–∏–Ω–∞ 5, –∫–≤. 10"`
   - –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ/–ø—Ä–æ–±–ª–µ–º–∞: `"–°/–º –Ω–µ –∫—Ä—É—Ç–∏—Ç –±–∞—Ä–∞–±–∞–Ω, —à—É–º–∏—Ç –ø—Ä–∏ –æ—Ç–∂–∏–º–µ"`
5. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è ‚Üí `"–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞"`
6. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã ‚Üí `"–Ω–µ –∫—Ä—É—Ç–∏—Ç –±–∞—Ä–∞–±–∞–Ω, —à—É–º–∏—Ç –ø—Ä–∏ –æ—Ç–∂–∏–º–µ"`
7. –í–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí ‚úÖ —É—Å–ø–µ—à–Ω–æ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
ParseResult(
    success=True,
    status="success",
    data=OrderParsed(
        equipment_type="–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞",
        problem_description="–Ω–µ –∫—Ä—É—Ç–∏—Ç –±–∞—Ä–∞–±–∞–Ω, —à—É–º–∏—Ç –ø—Ä–∏ –æ—Ç–∂–∏–º–µ",
        address="—É–ª. –õ–µ–Ω–∏–Ω–∞ 5, –∫–≤. 10",
        client_name="–ö–ª–∏–µ–Ω—Ç",
        phone="+79001234567",
        scheduled_time="–∑–∞–≤—Ç—Ä–∞ –∫ 14:00",
        raw_message="...",
        message_id=12345
    ),
    error_message=None,
    missing_fields=[]
)
```

### –ü—Ä–∏–º–µ—Ä 2: –£—Å–ø–µ—à–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

**–í—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:**
```
—Ç–≤ –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è
–ì–∞–≥–∞—Ä–∏–Ω–∞ 12-5
```

**–ü—Ä–æ—Ü–µ—Å—Å –ø–∞—Ä—Å–∏–Ω–≥–∞:**
1. –†–∞–∑–±–∏–≤–∫–∞ ‚Üí 2 —Å—Ç—Ä–æ–∫–∏
2. –¢–µ–ª–µ—Ñ–æ–Ω ‚Üí –Ω–µ –Ω–∞–π–¥–µ–Ω, `None`
3. –í—Ä–µ–º—è ‚Üí –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, `None`
4. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ:
   - –ê–¥—Ä–µ—Å: `"–ì–∞–≥–∞—Ä–∏–Ω–∞ 12-5"` (—Å–æ–¥–µ—Ä–∂–∏—Ç —Ü–∏—Ñ—Ä—ã –∏ —Ç–∏—Ä–µ)
   - –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ/–ø—Ä–æ–±–ª–µ–º–∞: `"—Ç–≤ –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è"`
5. –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ‚Üí `"–¢–µ–ª–µ–≤–∏–∑–æ—Ä"`
6. –ü—Ä–æ–±–ª–µ–º–∞ ‚Üí `"–Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è"`
7. –í–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí ‚úÖ —É—Å–ø–µ—à–Ω–æ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
ParseResult(
    success=True,
    status="success",
    data=OrderParsed(
        equipment_type="–¢–µ–ª–µ–≤–∏–∑–æ—Ä",
        problem_description="–Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è",
        address="–ì–∞–≥–∞—Ä–∏–Ω–∞ 12-5",
        client_name="–ö–ª–∏–µ–Ω—Ç",
        phone=None,
        scheduled_time=None,
        raw_message="...",
        message_id=12346
    )
)
```

### –ü—Ä–∏–º–µ—Ä 3: –û—à–∏–±–∫–∞ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∞–¥—Ä–µ—Å

**–í—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:**
```
–°/–º —Ç–µ—á—ë—Ç –≤–æ–¥–∞ —Å–Ω–∏–∑—É
```

**–ü—Ä–æ—Ü–µ—Å—Å –ø–∞—Ä—Å–∏–Ω–≥–∞:**
1. –†–∞–∑–±–∏–≤–∫–∞ ‚Üí 1 —Å—Ç—Ä–æ–∫–∞
2. –¢–µ–ª–µ—Ñ–æ–Ω ‚Üí –Ω–µ –Ω–∞–π–¥–µ–Ω
3. –í—Ä–µ–º—è ‚Üí –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
4. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ:
   - –ê–¥—Ä–µ—Å: `""` (–Ω–µ—Ç —Å—Ç—Ä–æ–∫ –ø–æ—Ö–æ–∂–∏—Ö –Ω–∞ –∞–¥—Ä–µ—Å)
   - –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ/–ø—Ä–æ–±–ª–µ–º–∞: `"–°/–º —Ç–µ—á—ë—Ç –≤–æ–¥–∞ —Å–Ω–∏–∑—É"`
5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞ ‚Üí ‚ùå –ø—É—Å—Ç–æ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
ParseResult(
    success=False,
    status="missing_fields",
    data=None,
    error_message="–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å",
    missing_fields=["address"]
)
```

### –ü—Ä–∏–º–µ—Ä 4: –û—à–∏–±–∫–∞ ‚Äî –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç

**–í—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:**
```
–ø–æ—á–∏–Ω–∏—Ç—å
```

**–ü—Ä–æ—Ü–µ—Å—Å –ø–∞—Ä—Å–∏–Ω–≥–∞:**
1. –†–∞–∑–±–∏–≤–∫–∞ ‚Üí 1 —Å—Ç—Ä–æ–∫–∞: `"–ø–æ—á–∏–Ω–∏—Ç—å"`
2. –¢–µ–ª–µ—Ñ–æ–Ω ‚Üí –Ω–µ –Ω–∞–π–¥–µ–Ω
3. –í—Ä–µ–º—è ‚Üí –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
4. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ:
   - –ê–¥—Ä–µ—Å: `""`
   - –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ/–ø—Ä–æ–±–ª–µ–º–∞: `"–ø–æ—á–∏–Ω–∏—Ç—å"`
5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞ ‚Üí ‚ùå –ø—É—Å—Ç–æ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
ParseResult(
    success=False,
    status="missing_fields",
    data=None,
    error_message="–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å",
    missing_fields=["address"]
)
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —ç—Ç–∞–ø–∞–º–∏

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ —ç—Ç–∞–ø–æ–≤ 2-3:

**–ò–∑ equipment_dict.py:**
- `normalize_equipment_type()` ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∏–ø–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è

**–ò–∑ patterns.py:**
- `extract_phone()` ‚Äî –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- `normalize_phone()` ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- `contains_time_indicator()` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
- `looks_like_address()` ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–Ω—ã—Ö —Å—Ç—Ä–æ–∫

**–ò–∑ schemas.py:**
- `OrderParsed` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- `ParseResult` ‚Äî –æ–±—ë—Ä—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**Try-catch –±–ª–æ–∫–∏:**
1. **ValidationError** (Pydantic) ‚Äî –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. **Exception** (–æ–±—â–∏–π) ‚Äî –ø—Ä–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö

**–¢–∏–ø—ã –æ—à–∏–±–æ–∫:**
- `invalid_format` ‚Äî –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
- `missing_fields` ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
- `error` ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `logging.Logger` —Å –¥–≤—É–º—è —É—Ä–æ–≤–Ω—è–º–∏:

```python
self.logger.warning(f"–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Pydantic: {e}")
self.logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: {e}", exc_info=True)
```

- `WARNING` ‚Äî –¥–ª—è –æ–∂–∏–¥–∞–µ–º—ã—Ö –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `ERROR` ‚Äî –¥–ª—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π (—Å –ø–æ–ª–Ω—ã–º traceback)

### Type Hints

–ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤:

```python
def parse_message(self, text: str, message_id: int) -> ParseResult: ...
def _split_into_lines(self, text: str) -> list[str]: ...
def _extract_phone_from_lines(self, lines: list[str]) -> str | None: ...
def _split_equipment_and_address(self, lines: list[str]) -> tuple[str, str]: ...
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ —ç—Ç–∞–ø–∞

```
telegram_repair_bot/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îî‚îÄ‚îÄ telegram_parser/
‚îÇ           ‚îú‚îÄ‚îÄ __init__.py               # –û–±–Ω–æ–≤–ª—ë–Ω (+ OrderParserService)
‚îÇ           ‚îú‚îÄ‚îÄ equipment_dict.py         # –≠—Ç–∞–ø 2
‚îÇ           ‚îú‚îÄ‚îÄ patterns.py               # –≠—Ç–∞–ø 2
‚îÇ           ‚îú‚îÄ‚îÄ schemas.py                # –≠—Ç–∞–ø 3
‚îÇ           ‚îî‚îÄ‚îÄ parser_service.py         # NEW —ç—Ç–æ—Ç —ç—Ç–∞–ø
‚îî‚îÄ‚îÄ docs/
    ‚îî‚îÄ‚îÄ implementation/
        ‚îú‚îÄ‚îÄ stage1_infrastructure.md
        ‚îú‚îÄ‚îÄ stage2_patterns.md
        ‚îú‚îÄ‚îÄ stage3_schemas.md
        ‚îî‚îÄ‚îÄ stage4_parser_service.md      # NEW —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

**–≠–¢–ê–ü 5:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telethon
- `app/services/telegram_parser/telethon_client.py`
  - –ö–ª–∞—Å—Å `TelethonClient` ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram —á–µ—Ä–µ–∑ MTProto
  - –ú–µ—Ç–æ–¥ `start()` ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫
  - –ú–µ—Ç–æ–¥ `on_new_message()` ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `OrderParserService`

- `app/services/telegram_parser/confirmation_service.py`
  - –ö–ª–∞—Å—Å `OrderConfirmationService` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è–º–∏
  - –ú–µ—Ç–æ–¥ `send_confirmation()` ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ inline-–∫–Ω–æ–ø–æ–∫
  - –ú–µ—Ç–æ–¥ `handle_confirmation()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫

**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ –Ω–∞—á–∞–ª—É üü¢

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. ‚úÖ **–≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
2. ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π
3. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî Pydantic –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
4. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –ø–æ–ª—è—Ö
5. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –≤—Å–µ —ç—Ç–∞–ø—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
6. üìù **Fallback –ª–æ–≥–∏–∫–∞** ‚Äî –ø—Ä–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ç–æ—á–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [x] –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `parser_service.py`
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–ª–∞—Å—Å `OrderParserService`
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `parse_message()` —Å 7-—à–∞–≥–æ–≤—ã–º –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—Å–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –û–±–Ω–æ–≤–ª—ë–Ω `__init__.py` —Å —ç–∫—Å–ø–æ—Ä—Ç–æ–º —Å–µ—Ä–≤–∏—Å–∞
- [x] –û—Ç—á—ë—Ç —Å–æ–∑–¥–∞–Ω

---

**–ê–≤—Ç–æ—Ä:** Claude Code Sonnet
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~40 –º–∏–Ω—É—Ç
**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** –≠–¢–ê–ü 5 (TelethonClient + OrderConfirmationService)
