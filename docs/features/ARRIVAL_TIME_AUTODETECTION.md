# Автоопределение времени прибытия

В этом документе описан механизм автоматического определения времени прибытия мастера при создании заявки.

## Обзор

При создании заявки диспетчер может ввести время прибытия в свободной форме. Система автоматически распознает дату и время из введенного текста, используя комбинацию регулярных выражений и библиотеки `dateparser`.

## Основные компоненты

Логика распознавания сосредоточена в файле `app/utils/date_parser.py`.

Ключевые функции:

* `parse_natural_datetime(text, validate=True)`: Основная точка входа. Принимает текст, возвращает объект `datetime` и отформатированную строку.
* `_preprocess_time_text(text)`: Нормализует текст перед парсингом (приводит к нижнему регистру, обрабатывает специфичные фразы).
* `validate_parsed_datetime(dt, original_text)`: Проверяет корректность распознанной даты (не в прошлом, не слишком далеко в будущем).

Использование в диспетчере:

* Файл: `app/handlers/dispatcher.py`
* Функция: `process_scheduled_time`

## Алгоритм работы

1. **Предобработка текста (`_preprocess_time_text`)**:
    * Приведение к нижнему регистру.
    * Обработка ключевых слов: "завтра", "сегодня", "послезавтра".
    * Замена разговорных фраз:
        * "через час" -> "через 1 час"
        * "полчаса" -> "30 минут"
        * "полтора" -> "1.5"
    * Обработка специфичных паттернов, которые плохо понимает `dateparser` (например, "после 15", "до 12").

2. **Поиск паттернов и парсинг (`parse_natural_datetime`)**:
    * Функция пытается найти совпадения с заранее определенными регулярными выражениями для интервалов и специфичных форматов.
    * Если специфичный паттерн не найден, используется библиотека `dateparser` с настройками для часового пояса Москвы (`Europe/Moscow`).
    * Поддерживается ручной парсинг дат в формате `DD.MM.YYYY HH:MM` и `DD.MM.YYYY`, так как `dateparser` может ошибаться с порядком дня и месяца.

3. **Валидация (`validate_parsed_datetime`)**:
    * **Проверка на прошлое:** Дата не должна быть в прошлом (допускается погрешность 5 минут).
    * **Проверка на будущее:** Дата не должна быть более чем через 1 год.
    * **Предупреждения:** Если время менее чем через 30 минут, выдается предупреждение "Очень скоро".

## Поддерживаемые форматы

Система понимает множество форматов ввода. Ниже приведены основные примеры.

### Абсолютное время

* `10:00` (интерпретируется как сегодня или завтра, если время уже прошло)
* `завтра в 10`
* `01.11.2025 14:00`
* `01.11 14:00`

### Относительное время

* `через 2 часа`
* `через 30 минут`
* `через полтора часа`

### Интервалы

* `с 10 до 12`
* `10-12`
* `завтра с 14 до 16`
* `с 14:00 до 18:00`

### Специфичные выражения

* `после 15` (интерпретируется как "сегодня/завтра в 16:00")
* `до 12` (интерпретируется как интервал с текущего момента/начала рабочего дня до 12:00)
* `послезавтра`

## Особенности реализации

* **Часовой пояс:** Все операции с временем производятся в `Europe/Moscow`.
* **Рабочее время:** При обработке выражений типа "до 12", если текущее время нерабочее (22:00 - 08:00), начало интервала автоматически устанавливается на 08:00.
* **Умный перенос на завтра:** Если указанное время (например, "10:00") уже прошло сегодня, система автоматически предполагает, что имеется в виду завтрашний день.
