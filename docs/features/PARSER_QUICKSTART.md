# Быстрый старт парсера заявок

## Установка и запуск

### 1. Настройка переменных окружения

Добавьте в `.env`:

```env
# Telegram API (получить на https://my.telegram.org)
TELEGRAM_API_ID=your_api_id
TELEGRAM_API_HASH=your_api_hash
TELEGRAM_PHONE=+79001234567

# ID группы диспетчеров для уведомлений
DISPATCHER_GROUP_ID=-1001234567890
```

### 2. Настройка базы данных

```sql
-- Добавьте конфигурацию парсера
INSERT INTO parser_config (group_id, enabled)
VALUES (-5023235262, 1);  -- Замените на ID вашей группы
```

**Как получить ID группы**:

1. Добавьте бота `@username_to_id_bot` в группу
2. Отправьте команду `/start`
3. Скопируйте ID группы (отрицательное число)

### 3. Авторизация

При первом запуске введите код подтверждения из SMS/Telegram:

```bash
python bot.py
# Введите код: 12345
```

### 4. Готово

Парсер автоматически начнёт обрабатывать сообщения из группы.

## Формат сообщений

### ✅ Корректный формат

```
Холодильник не морозит
Ленина 20 кв 45
89001234567
Завтра в 10
```

### ✅ Также поддерживается

```
Иван Петров
Электрика не работает розетка
Гагарина 15 кв 39
Через 1-1.5 часа
+7 (950) 348-95-55
```

### ❌ Неправильный формат

```
Холодильник  # Нет описания проблемы
Ленина 20
895348955    # Неполный номер (9 цифр вместо 11)
```

## Поддерживаемые форматы времени

| Формат | Пример | Результат |
|--------|--------|-----------|
| Относительное | "через 1 час" | Текущее время + 1 час |
| Диапазон | "через 1-1.5 часа" | Текущее время + 1.25 часа |
| Абсолютное | "завтра в 10" | 30.11.2025 10:00 |
| Интервал | "с 10 до 12" | 29.11.2025 10:00 |
| После времени | "после 15" | 29.11.2025 16:00 |
| Конкретная дата | "01.11.2025 14:00" | 01.11.2025 14:00 |

## Возможности

✅ Автоматическое извлечение данных (оборудование, адрес, телефон, время)
✅ Интеллектуальный парсинг времени на естественном языке
✅ Валидация телефонов (11 цифр)
✅ Валидация описания проблемы
✅ Проверка на дубликаты
✅ История клиента
✅ Подтверждение через inline-кнопки

## Управление

### Отключить парсер

```sql
UPDATE parser_config SET enabled = 0 WHERE group_id = -5023235262;
```

### Включить парсер

```sql
UPDATE parser_config SET enabled = 1 WHERE group_id = -5023235262;
```

### Изменить группу

```sql
UPDATE parser_config SET group_id = -1001234567890 WHERE id = 1;
```

После изменений требуется **перезапуск бота**.

## Troubleshooting

### Сброс аутентификации

**Проблема:** Парсер не может аутентифицироваться или застрял в процессе авторизации

**Решение:**

```bash
/parser_reset  # Сбрасывает сессию без перезапуска контейнера
/parser_auth   # Заново проходит аутентификацию
```

**Важно при вводе кода:** Используйте пробелы или дефисы (например: `1 2 3 4 5`), чтобы Telegram не заблокировал вход.

### Ошибки при аутентификации

**Неверный код подтверждения:**

- Проверьте код в Telegram
- Код действителен только несколько минут
- Если код истек, используйте `/parser_reset` и `/parser_auth` для нового кода

**Неверный пароль 2FA:**

- Проверьте пароль облачной аутентификации
- Пароль чувствителен к регистру

**Слишком много попыток:**

- Telegram временно заблокировал аутентификацию
- Подождите указанное время (обычно несколько минут)
- Не пытайтесь до истечения времени блокировки

**Парсер не запускается**: Проверьте переменные окружения и конфигурацию в БД

**Заявки не создаются**: Проверьте формат сообщений и логи парсера

**Время не определяется**: Убедитесь что используете поддерживаемые форматы

## Полная документация

См. [TELEGRAM_PARSER.md](TELEGRAM_PARSER.md) для подробной информации.
