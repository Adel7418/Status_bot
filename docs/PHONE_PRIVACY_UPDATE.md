# Обновление конфиденциальности: Скрытие номера телефона

## Дата обновления
12 октября 2025

## Описание изменений

Реализована система скрытия номера телефона клиента от мастера до момента прибытия на объект.

## Логика работы

### Видимость номера телефона в зависимости от статуса заявки:

1. **ASSIGNED (Назначена)** - номер телефона СКРЫТ
   - Показывается сообщение: *"Будет доступен после прибытия на объект"*
   
2. **ACCEPTED (Принята)** - номер телефона СКРЫТ
   - Показываются имя клиента и адрес
   - Номер телефона заменен на: *"Будет доступен после прибытия на объект"*
   
3. **ONSITE (Я на объекте)** - номер телефона ВИДЕН ✅
   - Мастер получает полный доступ к номеру телефона
   
4. **DR (Длительный ремонт)** - номер телефона ВИДЕН ✅
   - Сохраняется доступ к номеру
   
5. **CLOSED (Завершена)** - номер телефона ВИДЕН ✅
   - Сохраняется доступ к номеру

## Затронутые файлы

### 1. `app/handlers/master.py`
- **Функция:** `callback_view_order_master` (строки 135-152)
- **Изменение:** Изменена логика отображения контактной информации
  - Полная информация (включая телефон) показывается только при статусах: ONSITE, DR, CLOSED
  - При статусе ACCEPTED показывается имя, адрес, но телефон скрыт
  - При статусе ASSIGNED вся контактная информация скрыта

### 2. `app/handlers/group_interaction.py`
Внесены изменения в следующие функции:

#### a) `callback_group_accept_order` (строка 65)
- При принятии заявки в группе номер телефона заменен на текст-заглушку
- Статус: ACCEPTED → телефон скрыт

#### b) `callback_group_refuse_order` (строка 136)
- При отклонении заявки номер телефона полностью убран из сообщения
- Мастер не должен получить доступ к номеру, если он отклонил заявку

#### c) `cmd_order_in_group` (строки 409-415)
- Добавлена условная проверка статуса заявки при просмотре через команду /order
- ONSITE, DR, CLOSED → номер виден
- ACCEPTED → номер скрыт с пояснением
- Другие статусы → "Недоступно"

### 3. `app/handlers/dispatcher.py`
Внесены изменения в уведомления о назначении мастера:

#### a) `callback_select_master_for_order` (строка 693)
- При назначении мастера на заявку через группу номер телефона скрыт
- Статус: ASSIGNED → телефон скрыт

#### b) `callback_select_new_master_for_order` (строка 901)
- При переназначении мастера номер телефона также скрыт
- Новый мастер получает скрытый номер телефона до прибытия на объект

## Где номер телефона остается видимым

### Для администраторов и диспетчеров:
- Номер телефона виден на всех этапах
- Это необходимо для управления заявками и контроля

### Для мастеров:
- При личном просмотре заявок после статуса ONSITE
- В групповых чатах после статуса ONSITE
- В завершенных заявках (CLOSED) для истории

## Преимущества изменений

1. **Защита данных клиента** - номер телефона не раскрывается преждевременно
2. **Контроль процесса** - мастер должен сначала принять заявку и прибыть на объект
3. **Снижение отказов** - мастер не может связаться с клиентом напрямую до прибытия
4. **Прозрачность** - мастер видит понятное сообщение о том, когда номер станет доступен

## ⚠️ Важно: Перезапуск бота

**После внесения изменений обязательно перезапустите бота!**

Изменения в коде не применяются автоматически к уже запущенному боту. Необходимо:

1. Остановить бота (Ctrl+C или закрыть терминал)
2. Запустить заново: `python bot.py`

## Тестирование

Рекомендуется протестировать следующие сценарии:

1. Назначение новой заявки мастеру через группу
2. Просмотр заявки мастером в личных сообщениях (статус ASSIGNED)
3. Принятие заявки мастером (статус ACCEPTED)
4. Перевод статуса в "Я на объекте" (статус ONSITE) - проверить, что номер стал виден
5. Переназначение заявки на другого мастера
6. Просмотр заявки через команду /order в группе

## Примечания

- Изменения не затрагивают права администраторов и диспетчеров
- В логах аудита все действия продолжают фиксироваться
- Изменения обратно совместимы с существующей базой данных

## Возможные дополнительные улучшения

1. Добавить настройку для гибкого управления видимостью номера
2. Логировать факт просмотра номера телефона мастером
3. Добавить уведомление клиенту, когда мастер получил доступ к его номеру

