# Новые правила расчета прибыли: роль SENIOR_MASTER и тип техники "Водонагреватели"

**Дата:** 23 ноября 2025

В систему расчета прибыли были внесены два ключевых изменения для повышения гибкости и мотивации мастеров.

## 1. Новая роль: `SENIOR_MASTER`

### Описание
Добавлена новая роль пользователя — `SENIOR_MASTER`. Мастера с этой ролью получают **гарантированную минимальную долю прибыли в 50%** от чистой прибыли заказа (Общая сумма - Расходные материалы).

### Логика работы
- **Гарантия 50%:** Если стандартный расчет прибыли (например, 40/60) дает мастеру долю менее 50%, система автоматически увеличит его долю до 50%.
- **Приоритет:** Это правило применяется *после* базового расчета, но *до* начисления бонусов за выезд за город.
- **Цель:** Мотивировать и поощрять самых опытных и ценных мастеров.

### Технические детали
- **Роль добавлена в:** `app/core/constants.py`
- **Логика расчета обновлена в:** `app/utils/helpers.py` в функции `calculate_profit_split`.
- Все вызовы `calculate_profit_split` в `app/handlers/dispatcher.py` и `app/handlers/master.py` были обновлены для передачи ролей мастера в функцию.

## 2. Фиксированная ставка для типа техники "Водонагреватели"

### Описание
Для всех заказов, где тип техники — **"Водонагреватели"**, теперь применяется фиксированное распределение чистой прибыли **50/50** между мастером и компанией.

### Логика работы
- **Фиксированная ставка:** Независимо от суммы заказа, чистая прибыль делится пополам.
- **Приоритет:** Это правило имеет наивысший приоритет и применяется *в самом начале* расчета прибыли, переопределяя все остальные правила (кроме бонусов за выезд и отзыв).
- **Цель:** Установить единые и понятные условия для конкретного, часто встречающегося типа работ.

### Технические детали
- **Логика расчета обновлена в:** `app/utils/helpers.py` в функции `calculate_profit_split`.

## Как это работает вместе?

1.  Сначала проверяется тип техники. Если это "Водонагреватели", устанавливается разделение 50/50.
2.  Если нет, происходит стандартный расчет (например, 40/60 в зависимости от суммы).
3.  Затем, если у мастера есть роль `SENIOR_MASTER` и его доля получилась меньше 50%, она принудительно поднимается до 50%.
4.  В конце к доле мастера прибавляется бонус за выезд за город.

Эти изменения обеспечивают более гибкую и справедливую систему вознаграждения для мастеров.
