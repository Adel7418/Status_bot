logic (Formula) for the application parser:

1. Общий смысл

Бот получает текстовое сообщение в группе.
Сообщение обычно содержит:

краткое описание техники,

краткое описание проблемы,

адрес (одна или две строки),

телефон,

ориентировочное время визита.

Задача: корректно вытащить эти данные, минимально опираясь на строгий формат, т.к. сообщений много, и все пишут “как попало”.

2. Основные этапы разбора сообщения

Разбор делится на четыре части:

1) Обработка текста

Текст делится на отдельные строки, пустые строки убираются.

2) Определение телефона

Начиная с конца сообщения ищется строка, содержащая телефон:

начинается с +7 или 8,

содержит не менее 8 цифр,

допускаются пробелы, скобки, дефисы.

Если строка найдена, она исключается из дальнейшего анализа.

3) Определение времени визита

Определяется строка, содержащая указание времени.
Признаки:

наличие формата “часы:минуты”,

или слов: завтра, через, к, в течение, час, обеда, вечера, утра, после,

или интервалов: 1–1.5, 1.5–2.

Если строка есть — она исключается из дальнейшего анализа.
Если нет — время считается неуказанным.

4) Разделение текста на блок с техникой/проблемой и блок с адресом

Оставшиеся строки делятся логически:

Верхняя часть — техника и проблема.

Нижняя часть — адрес.

Признаки адреса:

наличие цифр,

наличие слов для улиц: кв, кВ, дом, ул, пер, пр, корпус, этаж, подъезд,

наличие известных топонимов (названия улиц/городов).

Если вторая строка похожа на адрес → техника указана в первой строке.
Если не похожа → техника и проблема занимают первые две строки.

Адрес состоит из всех оставшихся строк (иногда с городом или районом).

3. Определение типа техники и описания проблемы

Тип техники определяется словарём ключевых слов:

С/м, С//м, стиралка

П/м, посудомойка

ТВ, Тв, телевизор

Холодильник, ларь

ВП, варочная панель

ДШ, духовка

Кондиционер

Кофемашина

Электрика, электрик

Сантехника

и другие часто встречаемые варианты

Если ключевое слово найдено:

оно считается типом техники,

остальной текст — описание проблемы.

Если ключевого слова нет:

тип техники считается неопределённым,

весь верхний блок автоматически становится описанием проблемы.

Если проблема не указана (например, “С/м Бош”) — ставится “не указано”.

4. Проверки перед созданием заявки

Чтобы заявка считалась корректной, необходимо:

адрес должен быть непустым и содержать хотя бы одно число (дом, квартира),

должен быть определён тип техники.

Описание проблемы — может быть любым.
Телефон и время — необязательны.

Если не хватает данных:

бот пишет в чат просьбу оформить сообщение так, чтобы можно было извлечь технику, проблему и адрес.

5. Поведение после успешного разбора

Заявка создаётся или дополняется в базе:

создаётся новая, если похожей заявки нет,

либо обновляется, если раньше в этот же день была неполная заявка с тем же телефоном/адресом.

Бот отправляет подтверждение в группу:

кратко сообщает, что данные приняты,

просит назначить мастера.

6. Тестирование

Рекомендуется:

тестировать распознавание телефона,

тестировать распознавание времени,

тестировать разделение техники/проблемы от адреса,

тестировать типовые примеры, включая “неаккуратные” сообщения,

тестировать ошибочные сообщения, где бот должен просить повторить ввод.

Минимальный порог:

Юнит-тесты ≈ 80%.

Интеграционные ≈ 10% (создание/обновление заявки в тестовой БД).
