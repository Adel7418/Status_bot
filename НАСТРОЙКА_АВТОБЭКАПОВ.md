# üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### **–ú–µ—Ç–æ–¥ 1: APScheduler (–≤–Ω—É—Ç—Ä–∏ –±–æ—Ç–∞)**
- üìÖ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ **03:00 –ú–°–ö**
- üíæ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
- üìß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ
- ‚úÖ **–£–ñ–ï –†–ê–ë–û–¢–ê–ï–¢** (–µ—Å–ª–∏ `BACKUP_ENABLED=true`)

### **–ú–µ—Ç–æ–¥ 2: Cron (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)**
- üìÖ –ö–∞–∂–¥—ã–µ **6 —á–∞—Å–æ–≤** (00:00, 06:00, 12:00, 18:00)
- üîí –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –±–æ—Ç —É–ø–∞–ª
- üìù –õ–æ–≥–∏ –≤ `/var/log/bot_backup.log`
- ‚öôÔ∏è **–¢–†–ï–ë–£–ï–¢ –ù–ê–°–¢–†–û–ô–ö–ò** (—Å–º. –Ω–∏–∂–µ)

---

## üöÄ –ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### **–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é**

–í `env.production` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```bash
BACKUP_ENABLED=true
BACKUP_SCHEDULE=0 3 * * *  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00
```

### **–®–∞–≥ 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞**

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd ~/telegram_repair_bot
git pull
make prod-deploy
```

–¢–µ–ø–µ—Ä—å –±—ç–∫–∞–ø—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00! ‚úÖ

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cron (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞)

### **–®–∞–≥ 1: –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º**

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
chmod +x ~/telegram_repair_bot/scripts/cron_backup.sh
```

### **–®–∞–≥ 2: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç**

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é
bash ~/telegram_repair_bot/scripts/cron_backup.sh
```

–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
```
OK: –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
INFO: –í—Å–µ–≥–æ –±—ç–∫–∞–ø–æ–≤: X
```

### **–®–∞–≥ 3: –î–æ–±–∞–≤—å—Ç–µ –≤ crontab**

```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ crontab
crontab -e

# –î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É (–±—ç–∫–∞–ø –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤):
0 */6 * * * /root/telegram_repair_bot/scripts/cron_backup.sh >> /var/log/bot_backup.log 2>&1

# –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ –≤—ã–π–¥–∏—Ç–µ (Ctrl+X, Y, Enter –≤ nano)
```

### **–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ cron –¥–æ–±–∞–≤–ª–µ–Ω**

```bash
crontab -l | grep backup
```

–î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:
```
0 */6 * * * /root/telegram_repair_bot/scripts/cron_backup.sh >> /var/log/bot_backup.log 2>&1
```

---

## üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤

### **APScheduler (–≤ –±–æ—Ç–µ):**
- 03:00 –ú–°–ö - –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±—ç–∫–∞–ø

### **Cron (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ):**
- 00:00 - –±—ç–∫–∞–ø
- 06:00 - –±—ç–∫–∞–ø
- 12:00 - –±—ç–∫–∞–ø
- 18:00 - –±—ç–∫–∞–ø

**–ò—Ç–æ–≥–æ: 5 –±—ç–∫–∞–ø–æ–≤ –≤ –¥–µ–Ω—å** (1 –æ—Ç –±–æ—Ç–∞ + 4 –æ—Ç cron)

---

## üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤

### **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞:**
- –û–±–∞ –º–µ—Ç–æ–¥–∞ —É–¥–∞–ª—è—é—Ç –±—ç–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ **30 –¥–Ω–µ–π**
- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏—Å–∫–∞

### **–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è:**

**–î–ª—è APScheduler:**
–ò–∑–º–µ–Ω–∏—Ç–µ –≤ –∫–æ–¥–µ `app/services/scheduler.py`:
```python
cutoff_date = datetime.now(MOSCOW_TZ) - timedelta(days=30)  # ‚Üê –ó–¥–µ—Å—å
```

**–î–ª—è cron:**
–ò–∑–º–µ–Ω–∏—Ç–µ –≤ `scripts/backup_db.py`:
```python
parser.add_argument("--keep-days", type=int, default=30)  # ‚Üê –ó–¥–µ—Å—å
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –±—ç–∫–∞–ø–æ–≤

### **–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ APScheduler:**

```bash
# –õ–æ–≥–∏ –±–æ—Ç–∞ (–∏—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ –±—ç–∫–∞–ø–µ)
docker logs telegram_repair_bot_prod | grep -i backup

# –ò–ª–∏ –≤ —Ñ–∞–π–ª–µ –ª–æ–≥–æ–≤
docker exec telegram_repair_bot_prod cat /app/logs/bot.log | grep -i backup | tail -10
```

### **–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ Cron:**

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
tail -50 /var/log/bot_backup.log
```

### **–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤:**

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
ls -lht ~/telegram_repair_bot/backups/ | head -10
```

---

## üìß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### **APScheduler:**
–ê–¥–º–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram:
- ‚úÖ –£—Å–ø–µ—à–Ω—ã–π –±—ç–∫–∞–ø (—Å —Ä–∞–∑–º–µ—Ä–æ–º —Ñ–∞–π–ª–∞ –∏ –¥–∞—Ç–æ–π)
- ‚ùå –û—à–∏–±–∫–∞ –±—ç–∫–∞–ø–∞ (—Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ—à–∏–±–∫–∏)

### **Cron:**
–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ email –∏–ª–∏ Telegram API

---

## üÜò –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–æ—Ç–∞
make prod-stop

# 2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤
ls -lht backups/

# 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω—É–∂–Ω—ã–π –±—ç–∫–∞–ø
cp backups/bot_database_2025-10-21_03-00-00.db data/bot_database.db

# 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∞
chown 1000:1000 data/bot_database.db

# 5. –£–¥–∞–ª–∏—Ç–µ WAL —Ñ–∞–π–ª—ã
rm -f data/bot_database.db-shm data/bot_database.db-wal

# 6. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞
make prod-start
```

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### **–î–ª—è –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞:**
- ‚úÖ APScheduler (1 —Ä–∞–∑ –≤ –¥–µ–Ω—å)
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ 30 –¥–Ω–µ–π

### **–î–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞:**
- ‚úÖ APScheduler (1 —Ä–∞–∑ –≤ –¥–µ–Ω—å)
- ‚úÖ Cron (–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤)
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ 30 –¥–Ω–µ–π

### **–î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–∏—Å—Ç–µ–º:**
- ‚úÖ APScheduler (1 —Ä–∞–∑ –≤ –¥–µ–Ω—å)
- ‚úÖ Cron (–∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞)
- ‚úÖ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ 90 –¥–Ω–µ–π

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –±—ç–∫–∞–ø–æ–≤

1. **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   ```bash
   # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞
   gpg --symmetric --cipher-algo AES256 backup.db
   ```

2. **–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:**
   ```bash
   chmod 600 backups/*.db
   ```

3. **–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ:**
   - Yandex Disk
   - Google Drive
   - AWS S3
   - Dropbox

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±—ç–∫–∞–ø—ã —Å–æ–∑–¥–∞—é—Ç—Å—è
make prod-logs | grep -i backup

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –±—ç–∫–∞–ø—ã
ls -lht backups/ | head -5
```

---

**–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–±—ç–∫–∞–ø–æ–≤ –≥–æ—Ç–æ–≤–∞! –¢–µ–ø–µ—Ä—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!** üéâ

